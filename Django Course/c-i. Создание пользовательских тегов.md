Простые теги (simple tags)

Включаемые теги (inclusion tags)

Работа с аргументами функции-тега

В Django можно создавать два типа пользовательских тегов - простые теги и включаемые теги.

### Простые теги (simple tags)

Простые теги позволяют создавать пользовательские теги, которые принимают аргументы и возвращают строку после их обработки.

**Когда применять:**

Простой тег может быть использован для выполнения сложных вычислений или обработки данных в шаблоне. Например, вы можете создать простой тег, который форматирует дату или время.

Простые теги полезны, когда требуется повторное использование определенной логики или вычислений в разных частях шаблона.

**Последовательность шагов для создания простого тега:**

1. Приложение должно содержать каталог `templatetags` на том же уровне, что и `models.py`, `views.py` и т.д. Если он еще не существует, создайте его - не забудьте про файл `__init__.py`, чтобы каталог воспринимался как пакет Python.
2. В папке `templatetags` создайте файл с расширением `.py` (например, `custom_tags.py`).> [!important]  
    > Сервер не перезапускается автоматически!После добавления модуля templatetags вам нужно перезапустить сервер, прежде чем вы сможете использовать теги или фильтры в шаблонах.  
    
3. Импортируйте модуль `template` из Django. Создайте экземпляр класса `template.Library()`.
4. Создайте функцию, которая будет выполнять логику вашего простого тега. Эта функция должна принимать необходимые аргументы и возвращать результат обработки.
5. Используйте декоратор `register.simple_tag` для регистрации вашей функции в качестве простого тега. В этот декоратор можно передать несколько параметров:
    - **name (необязательный):**
        - Определяет имя, под которым простой тег будет доступен в шаблонах.
        - По умолчанию имя функции используется как имя тега. Однако, если вы хотите задать кастомное имя, вы можете использовать этот аргумент.
        - Пример: `@register.simple_tag(name='my_tag')`
    - **takes_context (необязательный):**
        - Указывает, будет ли вашему тегу передан контекст шаблона в качестве первого аргумента.
        - По умолчанию установлен в `False`.
        - Пример: `@register.simple_tag(takes_context=True)`
        - Если установлен в `True`, первым аргументом вашей функции будет контекст шаблона. При использовании этой настройки, не забудьте добавить в функцию в качестве первого аргумента - `context`. В противном случае, первым аргументом будет первый аргумент, переданный в тег.
6. Для того, чтобы использовать тег в шаблоне - сперва подгрузите файл с кастомными тегами в шаблон `{% load custom_tags %}`. Теперь можно использовать тег в шаблоне, как встроенные теги `{% my_tag %}`.
7. Аргументы, которые используются в функции, можно передать после имени тега через пробел. Тег может принимать как позиционные, так и ключевые аргументы, при чём вторые должны быть указаны последними - `{% my_tag arg1 arg2 key1=value1 key2=value2 %}`.
8. Чтобы сохранить данные, которые возвращает функция-тег, используйте ключевое слово `as`, а после него имя переменной, в которую они будут сохранены. Например, `{% my_tag as new_data %}`.

**Пример использования:**

```Python
# custom_tags.py
from django import template
import my_app.views as views


register = template.Library()

@register.simple_tag()
def get_user_data(arg1, arg2):
    user_data = views.users_db
    return user_data
```

```HTML
<!-- любой html файл -->
{% load custom_tags %}
{% get_user_data as user_data %}
```

### Включаемые теги (inclusion tags)

Включаемые теги также позволяют создавать пользовательские теги, но в отличие от простых тегов, они возвращают результат обработки шаблона, который может быть встроен в основной шаблон.

**Когда применять:**

Включаемые теги особенно полезны, когда требуется повторно использовать фрагменты HTML-кода с определенной логикой или функциональностью (таких как виджеты, блоки содержимого или целые секции страницы) в разных частях приложения.

**Последовательность шагов для создания включаемого тега:**

1-3. Шаги аналогичны созданию простого тега.

1. Создайте функцию, которая будет выполнять логику вашего включаемого тега. Эта функция должна принимать необходимые аргументы и возвращать **словарь** контекста.
2. Создайте HTML-шаблон, который будет использоваться в вашем включаемом теге. Этот шаблон может содержать любой HTML-код и использовать переменные контекста, переданные из вашей функции.
3. Используйте декоратор `register.inclusion_tag` для регистрации вашей функции в качестве включаемого тега. Первым обязательным аргументом передайте путь до html-шаблона, необязательные аргументы - `name` и `takes_context`, которые работают так же, как для простых тегов.
4. Для того, чтобы использовать тег в шаблоне - подгружаем файл с кастомными тегами в шаблон `{% load custom_tags %}`. Теперь можно использовать тег в шаблоне, как встроенные теги `{% my_tag %}`.
5. Аргументы, которые используются в функции, можно передать после имени тега через пробел. Тег может принимать как позиционные, так и ключевые аргументы, при чём вторые должны быть указаны последними - `{% my_tag arg1 arg2 key1=value1 key2=value2 %}`.

**Пример использования:**

```Python
# custom_tags.py
from django import template
import basefunc.views as views

register = template.Library()


@register.inclusion_tag('basefunc/cats_menu.html')
def cats_menu(cat_id):
    cats = views.cats_db
    return {'cats': cats, 'cat_id': cat_id}
```

```HTML
<!-- basefunc/cats_menu.html -->
{% for cat in cats %}
    {% if cat.id == cat_id %}
        <li class="selected">{{ cat.name }}</li>
    {% else %}
        <li><a href="{% url 'category' cat.id %}">{{ cat.name }}</a></li>
    {% endif %}
{% endfor %}
```

```HTML
<!-- base.html -->
{% load custom_tags %}
{% cats_menu cat_id %}
```

### Работа с аргументами функции-тега

- Аргументы могут использоваться для выполнения различной логики внутри функции-тега. Например, можно использовать их для получения дополнительных данных из базы данных или для вычисления значений.
- Можно передать значения аргументов в контекст шаблона, чтобы они стали доступны в HTML-шаблоне. Для этого нужно вернуть словарь, в котором ключи будут именами переменных, а значения - значениями аргументов.
- Значения аргументов становятся доступными в HTML-шаблоне как переменные контекста. Можно использовать их в шаблоне, обращаясь к ним по их именам.

**Пример**:

```Python
@register.inclusion_tag('my_template.html')
def my_inclusion_tag(arg1, arg2):
    context = {
        'arg1': arg1,
        'arg2': arg2,
        'sum': arg1 + arg2  # Выполнение логики внутри тега
    }
    return context
```

В шаблоне `my_template.html`:

```HTML
<p>Argument 1: {{ arg1 }}</p>
<p>Argument 2: {{ arg2 }}</p>
<p>Sum: {{ sum }}</p>
```

<div class="page-break" style="page-break-before: always;"></div>
