Описание

Пример использования

Наследование

RedirectURLMixin

Краткое summery по LoginView

LogoutView

### Описание

**LoginView** - это класс представления (view) в Django, который значительно упрощает создание страницы аутентификации пользователей на сайте. Он инкапсулирует в себе всю необходимую логику для отображения формы входа и обработки данных при её отправке.

**Основные преимущества использования LoginView:**

1. **Готовая функциональность "из коробки"**
    
    LoginView избавляет нас от необходимости писать код для отображения формы логина и обработки ее отправки. Всё, что нужно - это указать путь к нему в файле `urls.py` и создать шаблон страницы входа. Об остальном позаботится Django.
    
2. **Гибкая конфигурация через атрибуты класса**
    
    У LoginView есть набор атрибутов, которые позволяют легко кастомизировать его поведение. Например, с помощью `template_name` можно указать свой шаблон, через `authentication_form` - задать форму авторизации, а `extra_context` позволяет передать в шаблон дополнительные переменные.
    
3. **Встроенная обработка ошибок и edge-cases**
    
    LoginView сам умеет обрабатывать различные ситуации. Если пользователь ввел неверные данные - он покажет ошибку. Если пользователь уже авторизован, а вы включили `redirect_authenticated_user` - он будет перенаправлен на другую страницу. Если не указан `next` в URL - используется `LOGIN_REDIRECT_URL` из настроек проекта. И так далее.
    
4. **Расширяемость через наследование**
    
    Если вам нужна не просто страница логина, а что-то более специфичное - не проблема! Создайте свой класс, унаследуйте его от LoginView и переопределите необходимые методы и атрибуты. Вы получите всю мощь LoginView и свою кастомную логику сверху.
    

### **Пример использования**

Чтобы задействовать LoginView в проекте, необходимо сделать следующее:

1. Добавить путь в `urls.py`:
    
    ```Python
    from django.contrib.auth.views import LoginView
    
    urlpatterns = [
        path('login/', LoginView.as_view(), name='login'),
        ...
    ]
    ```
    
2. Создать шаблон страницы входа (по умолчанию `registration/login.html`):
    
    ```HTML
    {% extends 'base.html' %}
    
    {% block content %}
      <h2>Войти на сайт</h2>
    
      {% if form.errors %}
        <p>Неверное имя пользователя или пароль.</p>
      {% endif %}
    
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Войти</button>
      </form>
    {% endblock %}
    ```
    
3. Настроить переадресацию после успешного входа в `settings.py` (опционально):
    
    ```Python
    LOGIN_REDIRECT_URL = '/'# Куда редиректить после входа
    ```
    

На этом всё! Теперь по адресу `/login/` у вас будет отображаться страница с формой входа. При отправке формы с корректными данными, пользователь будет авторизован и перенаправлен на `LOGIN_REDIRECT_URL`. В случае ошибки - форма будет отображена повторно с сообщением о неправильном логине или пароле.

**Доп. переменные для** `**settings.py**`**:**

- `LOGIN_URL` определяет, куда отправлять неавторизованного пользователя, который пытается попасть на защищенную страницу.
- `LOGOUT_REDIRECT_URL` определяет, куда отправлять пользователя после выхода из системы.

В шаблоне доступны следующие переменные:

- `form` - объект формы аутентификации
- `next` - URL для редиректа после успешного входа (если передан в GET-параметре)
- `site` - текущий сайт (экземпляр django.contrib.sites.models.Site)
- `site_name` - имя текущего сайта

### Наследование

- **RedirectURLMixin** - миксин, который добавляет функциональность для обработки URL перенаправления (redirect URL).
- [[i-e. Класс FormView (+ FormMixin, ProcessFormView, BaseFormView)]] - базовый класс для обработки форм в Django.

Благодаря `RedirectURLMixin` мы можем задать URL для редиректа либо через параметр `next` в GET-запросе, либо через настройку `LOGIN_REDIRECT_URL` в settings.py.

`FormView` в свою очередь предоставляет готовую реализацию отображения и валидации формы по указанному классу (по умолчанию `AuthenticationForm`).

### RedirectURLMixin

`RedirectURLMixin` - это миксин, который предоставляет функциональность для определения URL перенаправления после успешного действия (в случае LoginView - после успешной аутентификации).

**Основные методы и атрибуты** **`RedirectURLMixin`****:**

- `next_page` - атрибут, указывающий на URL или именованный URL-шаблон, куда следует перенаправлять после успешного действия (по умолчанию `None`). По сути это аналог атрибута `success_url` для данного класса.
    1. **Переопределение в URLconf**
        
        Вы можете указать значение `next_page` прямо в определении URL-шаблона:
        
        ```Python
        from django.contrib.auth.views import LoginView
        
        urlpatterns = [
            path('login/', LoginView.as_view(next_page='/dashboard/'), name='login'),
        ]
        ```
        
        В этом примере после успешного входа пользователь будет перенаправлен на `/dashboard/`.
        
    2. **Переопределение в классе-представлении**
        
        Вы можете создать подкласс LoginView и задать значение `next_page` в нем:
        
        ```Python
        from django.contrib.auth.views import LoginView
        
        class CustomLoginView(LoginView):
            next_page = '/dashboard/'
        ```
        
        Затем используйте `CustomLoginView` вместо `LoginView` в своем URLconf.
        
    3. **Динамическое определение в методе** `**get_default_redirect_url()**`
        
        Если вам нужно динамически определять значение `next_page` на основе каких-то условий, вы можете переопределить метод `get_default_redirect_url()`:
        
        ```Python
        from django.contrib.auth.views import LoginView
        
        class CustomLoginView(LoginView):
            def get_default_redirect_url(self):
                if self.request.user.is_staff:
                    return '/admin/'
                else:
                    return '/dashboard/'
        ```
        
        Здесь после успешного входа администраторы будут перенаправлены на `/admin/`, а обычные пользователи - на `/dashboard/`.
        

- `redirect_field_name` - атрибут, задающий имя поля (в POST или GET запросе), которое содержит URL для перенаправления (по умолчанию `'next'`).

- `success_url_allowed_hosts` - атрибут, содержащий множество разрешенных хостов для перенаправления (по умолчанию пустое множество).
    
    Атрибут `success_url_allowed_hosts` в `RedirectURLMixin` используется для повышения безопасности перенаправлений после успешных действий.
    
    Дело в том, что URL для перенаправления может быть указан не только через `next_page` или `LOGIN_REDIRECT_URL`, но и динамически через GET-параметр `next` (имя параметра задается в `redirect_field_name`).
    
    Например, если пользователь перейдет на страницу логина по URL `/login/?next=http://evil.com`, то после успешного входа он может быть перенаправлен на `http://evil.com`, если не предпринять дополнительных мер безопасности.
    
    Атрибут `success_url_allowed_hosts` как раз и служит для ограничения списка разрешенных хостов, на которые может осуществляться перенаправление.
    
    По умолчанию `success_url_allowed_hosts` - это пустое множество. Значит, по умолчанию разрешено перенаправление только на текущий хост (значение `request.get_host()`).
    

- `get_success_url()` - метод, который возвращает URL для перенаправления после успешного действия. Сначала пытается получить URL через `get_redirect_url()`, а если он не указан - через `get_default_redirect_url()`.
- `get_redirect_url()` - метод, который возвращает URL для перенаправления, указанный пользователем в POST или GET параметре `redirect_field_name`, но только если этот URL считается безопасным (т.е. его схема и хост разрешены). Безопасность проверяется через вызов `url_has_allowed_host_and_scheme()`.
- `get_success_url_allowed_hosts()` - метод, который возвращает множество разрешенных хостов для перенаправления. По умолчанию это объединение хоста текущего запроса (`request.get_host()`) и значения атрибута `success_url_allowed_hosts`.
- `get_default_redirect_url()` - метод, который возвращает URL по умолчанию для перенаправления. Если задан атрибут `next_page` - возвращает его значение, обработанное через `resolve_url()`. Иначе генерирует исключение `ImproperlyConfigured`.

> [!important]  
> LoginView дополнительно переопределяет get_default_redirect_url(), чтобы возвращать settings.LOGIN_REDIRECT_URL, если next_page не задан.  

### Краткое summery по LoginView

**Атрибуты**

1. `template_name` - путь к шаблону страницы входа. По умолчанию `registration/login.html`.
2. `next_page` - атрибут, указывающий на URL или именованный URL-шаблон, куда следует перенаправлять после успешного действия (по умолчанию `None`). По сути это аналог атрибута `success_url` для данного класса.
3. `form_class` - класс формы для аутентификации. По умолчанию `AuthenticationForm`.
4. `success_url_allowed_hosts` - множество разрешенных хостов для перенаправления после успешного входа. По умолчанию пустое множество.
5. `extra_context` - дополнительные данные для контекста шаблона. По умолчанию `None`.

Пример переопределения атрибутов:

```Python
from django.contrib.auth.views import LoginView
from django.urls import reverse_lazy

class CustomLoginView(LoginView):
    template_name = 'myapp/login.html'
    next_page = reverse_lazy('home')
    success_url_allowed_hosts = {'example.com', 'sub.example.com'}
    extra_context = {'title': 'Авторизация'}
```

**Методы**

1. `get_default_redirect_url()` - возвращает URL для перенаправления по умолчанию. Используется, если не указаны `next_page` и `redirect_field_name`. По умолчанию возвращает `settings.LOGIN_REDIRECT_URL`.
2. `get_success_url()` - возвращает URL для перенаправления после успешного входа. Сначала пытается получить URL из `get_redirect_url()`, затем из `get_default_redirect_url()`.
3. `form_valid(form)` - вызывается при успешной валидации формы входа. Аутентифицирует пользователя и перенаправляет на URL, возвращаемый `get_success_url()`.

Пример переопределения методов:

```Python
from django.contrib.auth.views import LoginView

class CustomLoginView(LoginView):
    def get_default_redirect_url(self):
        if self.request.user.is_staff:
            return '/admin/'
        else:
            return '/dashboard/'
```

### LogoutView

Класс `LogoutView` в Django предоставляет готовую функциональность для выхода пользователя из системы. Он обрабатывает POST-запросы для выполнения выхода и перенаправляет пользователя на указанную страницу после успешного выхода.  
  
**Преимущества использования** **`LogoutView`****:**

- Упрощает процесс выхода пользователя из системы, предоставляя готовый механизм.
- Позволяет настраивать перенаправление после выхода с помощью атрибутов класса.
- Предоставляет шаблон по умолчанию для отображения страницы после выхода.
- Обеспечивает защиту от CSRF-атак при выходе через POST-запросы.

**Пример использования класса:**  
В этом примере мы определяем URL-путь для выхода пользователя, используя класс  
`LogoutView`. Мы указываем `next_page='/'`, чтобы перенаправить пользователя на главную страницу после выхода.

```Python
from django.urls import path
from django.contrib.auth.views import LogoutView

urlpatterns = [
    path('logout/', LogoutView.as_view(next_page='/'), name='logout'),
]
```

**Наследование**

Класс LogoutView наследуется от `RedirectURLMixin` и `TemplateView`:

- `RedirectURLMixin`: (описан выше) Этот миксин добавляет функциональность для получения URL-адреса перенаправления после успешного выхода. Он предоставляет методы `get_success_url()` и `get_default_redirect_url()` для определения URL-адреса перенаправления.
- [[i-b. Классы TemplateView, ContextMixin, TemplateResponseMixin]]: Этот класс представляет собой базовый класс для отображения шаблонов. Он обрабатывает GET-запросы и рендерит указанный шаблон с переданным контекстом.

**Описание атрибутов и методов класса:**

- `http_method_names`: Список допустимых HTTP-методов для этого представления. По умолчанию включает GET, HEAD, POST и OPTIONS.
- `template_name`: Имя шаблона, который будет использоваться для отображения страницы после выхода. По умолчанию - "registration/logged_out.html".
- `extra_context`: Дополнительный контекст, который будет передан в шаблон. Может быть использован для передачи дополнительных данных в шаблон.
- `dispatch(request, *args, **kwargs)`: Метод, который обрабатывает входящий запрос и определяет, какой метод (GET или POST) будет вызван для обработки запроса. Он также проверяет, является ли запрос GET-запросом, и выводит предупреждение о том, что выход через GET-запросы устарел и будет удален в Django 5.0.
- `post(request, *args, **kwargs)`: Метод, который обрабатывает POST-запрос на выход пользователя. Он вызывает `auth_logout(request)` для выхода пользователя из системы, получает URL-адрес перенаправления с помощью `get_success_url()` и выполняет перенаправление, если URL-адрес отличается от текущего пути запроса.
- `get(request, *args, **kwargs)`: Метод, который обрабатывает GET-запрос на выход пользователя. Он вызывает метод `post()` для обработки выхода и возвращает ответ.
- `get_default_redirect_url()`: Метод, который возвращает URL-адрес перенаправления по умолчанию после выхода. Он проверяет наличие атрибута `next_page`, настройки `LOGOUT_REDIRECT_URL` и текущего пути запроса.
- `get_context_data(**kwargs)`: Метод, который возвращает контекст данных для шаблона. Он добавляет информацию о текущем сайте, заголовке страницы и дополнительном контексте (`extra_context`).

<div class="page-break" style="page-break-before: always;"></div>
