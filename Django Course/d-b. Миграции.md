Описание миграций

Команды Django для работы с миграциями

### Описание миграций

Миграции - это механизм Django, который позволяет автоматически синхронизировать изменения в моделях с базой данных. Они представляют собой набор инструкций, которые описывают изменения, которые нужно внести в базу данных, такие как создание новых таблиц, добавление или удаление столбцов, изменение типов данных и т. д.

> [!important]  
> Миграция не равно таблица в базе данных. Это именно набор инструкций, который будет выполнен в базе данных. Список миграций при этом можно воспринимать как зафиксированные версии изменений в БД. При откате миграций из базы данных будут удалены все изменения, которые связаны с этой миграцией!  

**Зачем нужны миграции?**

- **Сохранение истории изменений:** Миграции позволяют отслеживать изменения, внесенные в модели, и при необходимости откатывать их.
- **Совместная работа:** Миграции позволяют разработчикам совместно работать над проектом, не беспокоясь о синхронизации изменений в базе данных.
- **Автоматизация:** Миграции автоматизируют процесс обновления схемы базы данных, что упрощает разработку и развертывание приложения.

**Как создаются миграции?**

- Django автоматически генерирует файлы миграций. Для этого используется команда `python manage.py makemigrations`.
- **Структура файла:** Файл миграции содержит Python-код, который описывает изменения, которые необходимо внести в базу данных.

**Где хранятся миграции?**

Миграции хранятся в директории `migrations` внутри директории каждого приложения Django.

**Как выполняются миграции?**

- Для применения миграций к базе данных используется команда `python manage.py migrate`.
- **Поэтапное применение:** Django применяет миграции последовательно, обновляя структуру базы данных в соответствии с изменениями, описанными в миграциях.

### **Команды Django для работы с миграциями**

**1.** `**makemigrations**`

**Описание:**

Создает новые миграции на основе изменений, обнаруженных в ваших моделях.

**Как работает:**

- Когда вы изменяете определения моделей в вашем приложении Django (например, добавляете новое поле или изменяете тип существующего поля), Django отслеживает эти изменения.
- Когда вы запускаете `makemigrations`, Django сравнивает текущее состояние моделей с предыдущим состоянием и генерирует миграции, описывающие необходимые изменения базы данных.

**Синтаксис**:

```Shell
python manage.py makemigrations [app_label]
```

**Пример с флагом:**

```Shell
python manage.py makemigrations myapp
```

По умолчанию команда `makemigrations` создает миграции для всех приложений в вашем проекте. Однако, если вы укажете конкретное приложение с помощью необязательного аргумента `app_label`, Django создаст миграции только для этого приложения.

**Флаги:**

- `--name <name>`: Позволяет задать имя для новой миграции. По умолчанию Django генерирует имя автоматически, но иногда бывает полезно задать имя вручную для более ясной идентификации миграции.
- `--empty [app_label] [migration_name]`: Создает пустую миграцию без автоматического определения изменений модели. Этот флаг полезен, когда вам нужно создать миграцию для каких-то специфических изменений, которые не могут быть автоматически обнаружены Django.
- `--dry-run`: Запускает команду в режиме "теста", при котором миграции не создаются, но выводится информация о том, какие изменения будут применены.
- `--noinput`: Запускает команду без ожидания ввода подтверждения. Используется в автоматических скриптах или командах, где требуется выполнение без вмешательства пользователя.

**2.** `**migrate**`

**Описание:**

Применяет миграции к базе данных.

- Применяет все непримененные миграции и обновляет структуру базы данных.

**Как работает:**

1. Когда вы создаете новую миграцию с помощью `makemigrations`, Django создает файлы миграций, описывающие изменения, которые нужно внести в базу данных.
2. Когда вы запускаете `migrate`, Django смотрит на текущее состояние базы данных и применяет все новые миграции, которые еще не были применены.

**Синтаксис**:

```Shell
python manage.py migrate [app_label] [migration_name]
```

По умолчанию применяет все не применённые миграции для проекта.

- При использовании параметра `app_label` можно применить миграции только в рамках указанного приложения, однако, если будут обнаружены связи с миграциями другого приложения, они так же будут применены.
- При использовании `migration_name` можно применить конкретную миграции, но здесь так же, как и в предыдущем случае могут быть применены миграции, которые связаны с текущей.
- Вместо номера миграции можно использовать параметр `zero`, в этом случае все миграции для текущего приложения будут отменены (как и все связанные с ними миграции других приложений).

**Для отката миграции** также используется команда `migrate` с указанием названия миграции, до которой нужно откатиться.

```Shell
python manage.py migrate [app_label] [previous_migration_name]
```

Где:

- `[app_label]` - это имя приложения, к которому относится миграция.
- `[previous_migration_name]` - это название миграции, до которой нужно откатиться.

**Флаги:**

- `--fake [app_label] [migration_name]` : Помечает миграцию как примененную без фактического применения изменений к базе данных. Это полезно, когда вы хотите пометить миграцию как примененную без выполнения фактических SQL-команд.
- `--fake-initial`: Применяет все миграции, кроме начальной, без применения фактических изменений.
- `--plan`: Показывает порядок, в котором миграции будут применены. Этот флаг полезен, когда вы хотите увидеть, какие миграции будут применены перед их фактическим применением.

**3.** `**sqlmigrate**`

**Описание:**

Позволяет получить SQL-код для указанной миграции. Это полезно для анализа того, какие конкретные SQL-запросы будут выполнены при применении миграции к базе данных.

**Как работает:**

1. Вы указываете название приложения и название миграции, для которой вы хотите получить SQL-код.
2. Django загружает миграцию, а затем генерирует и выводит соответствующий SQL-код для этой миграции.

**Синтаксис:**

```Shell
python manage.py sqlmigrate [app_label] [migration_name]
```

**4.** `**showmigrations**`

**Описание:**  
Предназначена для отображения состояния миграций в проекте Django. Она показывает, какие миграции были применены к базе данных (отмечена символом [X] рядом с названием миграции), а какие еще нет.  

**Синтаксис:**

```Shell
python manage.py showmigrations [app_label]
```

Где:

- `app_label` (необязательно): Определяет, для какого приложения показать состояние миграций. Если не указан, отображается состояние для всех приложений.

**Флаги**:

- `--plan`: Этот флаг позволяет отобразить порядок, в котором миграции будут применены к базе данных. Он полезен для анализа того, какие миграции будут применены в следующем запуске команды `migrate`.
- `--database DATEBASE` **:** Этот флаг позволяет указать имя базы данных, для которой нужно показать состояние миграций. Это полезно, если ваш проект использует несколько баз данных и вы хотите увидеть состояние миграций для конкретной базы данных.

<div class="page-break" style="page-break-before: always;"></div>
