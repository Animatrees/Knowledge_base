Терминология

Механизм авторизации

Таблицы

Модуль авторизации

### Терминология

**Аутентификация (Authentication)** - это процесс проверки личности пользователя. Она отвечает на вопрос: "Кто вы?". Другими словами, аутентификация подтверждает, что пользователь является тем, за кого себя выдает. Обычно это происходит через ввод логина и пароля, но также могут использоваться и другие методы, такие как биометрические данные или токены.

**Авторизация (Authorization)** - это процесс определения того, какие действия и ресурсы доступны аутентифицированному пользователю. Она отвечает на вопрос: "Что вам разрешено делать?". После успешной аутентификации, система авторизации проверяет права и разрешения пользователя и решает, может ли он выполнять определенные действия или получать доступ к определенным ресурсам.

> [!info] Using the Django authentication system | Django documentation  
> The web framework for perfectionists with deadlines.  
> [https://docs.djangoproject.com/en/5.0/topics/auth/default/#top](https://docs.djangoproject.com/en/5.0/topics/auth/default/#top)  

### Механизм авторизации

1. **Запрос от пользователя**: Пользователь отправляет запрос на защищенную страницу или ресурс на сервере.
2. **Проверка сессии**: Django проверяет, есть ли у пользователя активная сессия. Если сессия существует и содержит информацию об аутентифицированном пользователе, Django извлекает объект пользователя (`request.user`) из сессии.
3. **Проверка авторизации**: Django проверяет, имеет ли пользователь необходимые права доступа для запрошенной страницы или ресурса. Это может быть реализовано с помощью декораторов (`login_required`, `permission_required` и др.), примесей (mixins) или путем явной проверки прав доступа в самом представлении (view).
4. **Разрешение доступа**: Если пользователь аутентифицирован и имеет необходимые права доступа, Django разрешает доступ к запрошенной странице или ресурсу и возвращает соответствующий ответ.
5. **Перенаправление на страницу входа**: Если пользователь не аутентифицирован (нет активной сессии), Django перенаправляет его на страницу входа. Обычно URL страницы входа указывается в настройках `settings.py` в параметре `LOGIN_URL`.
6. **Аутентификация пользователя**: На странице входа пользователь вводит свои учетные данные (логин и пароль) в форму входа и отправляет их на сервер. Django получает эти данные и передает их функции `authenticate()` из модуля `django.contrib.auth`, которая проверяет их на соответствие зарегистрированным пользователям в базе данных.
7. **Создание сессии**: Если учетные данные верны, Django создает новую сессию для пользователя и сохраняет информацию о нем в сессии с помощью функции `login()`. Обычно информация о пользователе хранится в виде ключа `_auth_user_id` в сессии.
8. **Перенаправление на изначально запрошенную страницу**: После успешной аутентификации Django перенаправляет пользователя на изначально запрошенную страницу или ресурс. Теперь пользователь аутентифицирован и имеет доступ к защищенным частям сайта.
9. **Последующие запросы**: При последующих запросах от того же пользователя Django будет извлекать информацию о нем из сессии и использовать ее для авторизации доступа к защищенным страницам и ресурсам.

Этот процесс повторяется при каждом запросе пользователя к серверу, пока пользователь не выйдет из системы (logout) или его сессия не истечет.

Атрибут `is_authenticated` - это специальный атрибут, доступный у объекта пользователя (`request.user`), который указывает, является ли текущий пользователь аутентифицированным или нет.

- Если пользователь успешно прошел аутентификацию (вошел в систему), значение `request.user.is_authenticated` будет равно `True`.
- Если пользователь не аутентифицирован (анонимный пользователь), значение `request.user.is_authenticated` будет равно `False`.

### Таблицы

При использовании системы аутентификации и авторизации Django, автоматически будут созданы таблицы:

- `auth_group`: Эта таблица представляет группы пользователей. Группы используются для объединения пользователей с одинаковыми правами доступа. Поля таблицы:
    - `id`: Первичный ключ группы.
    - `name`: Название группы.
- `auth_group_permissions`: Эта таблица устанавливает связь многие-ко-многим между группами (`auth_group`) и разрешениями (`auth_permission`). Она определяет, какие разрешения назначены каждой группе. Поля таблицы:
    - `id`: Первичный ключ связи.
    - `group_id`: Внешний ключ, ссылающийся на таблицу `auth_group`.
    - `permission_id`: Внешний ключ, ссылающийся на таблицу `auth_permission`.
- `auth_permission`: Эта таблица содержит информацию о разрешениях (permissions) в приложении. Каждое разрешение связано с определенной моделью и определяет тип действия (чтение, запись, удаление и т.д.). Поля таблицы:
    - `id`: Первичный ключ разрешения.
    - `name`: Краткое название разрешения.
    - `content_type_id`: Внешний ключ, ссылающийся на таблицу `django_content_type`, которая содержит информацию о моделях приложения.
    - `codename`: Кодовое имя разрешения (например, `can_view`, `can_edit` и т.д.).
- `auth_user`: Эта таблица представляет пользователей в системе. Она содержит основную информацию о пользователях, такую как имя пользователя, пароль, электронная почта и т.д. Поля таблицы:
    - `id`: Первичный ключ пользователя.
    - `username`: Имя пользователя.
    - `password`: Хэш пароля пользователя.
    - `email`: Электронная почта пользователя.
    - Другие поля, связанные с пользователем (имя, фамилия, даты создания и последнего входа и т.д.).
- `auth_user_groups`: Эта таблица устанавливает связь многие-ко-многим между пользователями (`auth_user`) и группами (`auth_group`). Она определяет, к каким группам принадлежит каждый пользователь. Поля таблицы:
    - `id`: Первичный ключ связи.
    - `user_id`: Внешний ключ, ссылающийся на таблицу `auth_user`.
    - `group_id`: Внешний ключ, ссылающийся на таблицу `auth_group`.
- `auth_user_user_permissions`: Эта таблица устанавливает связь многие-ко-многим между пользователями (`auth_user`) и разрешениями (`auth_permission`). Она определяет, какие разрешения назначены каждому пользователю индивидуально, помимо разрешений, полученных через группы. Поля таблицы:
    - `id`: Первичный ключ связи.
    - `user_id`: Внешний ключ, ссылающийся на таблицу `auth_user`.
    - `permission_id`: Внешний ключ, ссылающийся на таблицу `auth_permission`.

### Модуль авторизации

1. Создание приложения "users":
    - В терминале выполнить команду `python manage.py startapp users` для создания нового приложения с именем "users".
2. Подключение приложения "users" в настройках проекта:
    - В файле `settings.py` добавить приложение "users" в список `INSTALLED_APPS`:
        
        ```Python
        INSTALLED_APPS = [
            ...
            "users.apps.UsersConfig",
        ]
        ```
        
    - Убедиться, что в списке `MIDDLEWARE` присутствуют необходимые модули для работы авторизации:
        
        ```Python
        MIDDLEWARE = [
            ...
            'django.contrib.sessions.middleware.SessionMiddleware',
            ...
            'django.contrib.auth.middleware.AuthenticationMiddleware',
            ...
        ]
        ```
        
        - **Что такое MIDDLEWARE простым языком)**
            
            MIDDLEWARE (промежуточное ПО) в Django - это набор компонентов, которые обрабатывают запросы и ответы между веб-сервером и приложением Django. Они действуют как "фильтры" или "посредники", через которые проходят все запросы и ответы.
            
            Представьте, что вы отправляете письмо (запрос) в офис компании (приложение Django). Прежде чем письмо попадет к адресату, оно проходит через несколько отделов (MIDDLEWARE), каждый из которых может выполнить определенные действия с письмом. Например:
            
            1. Отдел безопасности (SecurityMiddleware) проверяет, не содержит ли письмо опасных вложений.
            2. Отдел регистрации (SessionMiddleware) записывает информацию о письме в журнал.
            3. Отдел аутентификации (AuthenticationMiddleware) проверяет, есть ли у отправителя права на отправку письма.
            
            После обработки всеми отделами письмо попадает к адресату (view). Затем ответ от адресата проходит через те же отделы (MIDDLEWARE) в обратном порядке, и каждый отдел может внести свои изменения в ответ.
            
            Аналогично, в Django MIDDLEWARE обрабатывает запросы и ответы, выполняя различные задачи, такие как аутентификация, сжатие, кеширование, обработка сессий и многое другое. Они позволяют добавлять дополнительную функциональность и модифицировать запросы/ответы без изменения основного кода приложения.
            
3. Создание файла `urls.py` в приложении "users":
    - Создать файл `urls.py` в директории приложения "users".
    - Определить список маршрутов для авторизации и выхода пользователя:
        
        ```Python
        from django.urls import path
        from . import views
        
        urlpatterns = [
            path('login/', views.login_user, name='login'),
            path('logout/', views.logout_user, name='logout'),
        ]
        ```
        
4. Создание представлений (views) для авторизации и выхода пользователя:
    - В файле `views.py` приложения "users" определить функции представления `login_user()` и `logout_user()`:
        
        ```Python
        def login_user(request):
            return HttpResponse("login")
        
        def logout_user(request):
            return HttpResponse("logout")
        ```
        
5. Связывание маршрутов приложения "users" с проектом Django:
    - В файле `urls.py` пакета конфигурации проекта добавить маршруты приложения "users":
        
        ```Python
        urlpatterns = [
            path('admin/', admin.site.urls),
            path('', include('women.urls')),
            path('users/', include('users.urls', namespace="users")),
            path("__debug__/", include("debug_toolbar.urls")),
        ]
        ```
        
    - Использовать параметр `namespace` в функции `include()` для создания пространства имен маршрутов приложения "users".
6. Определение переменной `app_name` в файле `users/urls.py`:
    - В файле `users/urls.py` добавить переменную `app_name` для указания имени приложения:
        
        ```Python
        app_name = "users"
        ```
        
        Переменная `app_name` в файле `urls.py` приложения используется для задания пространства имен (namespace) для URL-адресов этого приложения.
        
        Когда вы включаете URLs приложения "users" в главный файл `urls.py` с помощью `include()`:
        
        ```Python
        urlpatterns = [
            ...
            path('users/', include('users.urls', namespace="users")),
            ...
        ]
        ```
        
        Вы указываете параметр `namespace="users"`, который задает пространство имен для URLs этого приложения. Однако, если в файле `users/urls.py` не указана переменная `app_name`, Django не сможет правильно связать пространство имен с URLs приложения и выдаст ошибку.
        
        > [!important]  
        > Таким образом, указание app_name в файле urls.py приложения является обязательным, если вы используете include() с параметром namespace в главном файле urls.py проекта. Это позволяет Django правильно разрешать имена URL-адресов и избегать конфликтов между приложениями.  
        

После выполнения этих шагов приложение "users" будет создано и настроено для работы с авторизацией пользователей. Можно будет обращаться к маршрутам авторизации и выхода пользователя, используя пространство имен `users`, например, `users:login`.

<div class="page-break" style="page-break-before: always;"></div>
