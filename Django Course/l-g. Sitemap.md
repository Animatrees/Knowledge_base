Описание

Когда sitemap нужен для сайта, а когда нет?

Рекомендации по созданию карты сайта

Генерируем sitemap с помощью Django

Кэширование vs актуальность

GenericSitemap

Добавляем в sitemap статичные страницы

Разбор структуры файла sitemap

### Описание

**Sitemap (Карта сайта)** - это специальный файл, который содержит структурированный список всех веб-страниц вашего сайта. Его главная цель - помочь поисковым системам, таким как Google или Яндекс, лучше индексировать и понимать содержимое вашего сайта.

**Преимущества наличия карты сайта:**

1. **Ускорение индексации**  
    Поисковые системы быстрее узнают о новых страницах сайта благодаря sitemap, поэтому процесс индексации и отображения сайта в результатах поиска происходит быстрее.  
    
2. **Лучшая индексация глубоких страниц**  
    Поисковые системы могут обнаружить страницы, которые не были найдены при обычном сканировании сайта. Это не гарантирует индексацию всех этих страниц, но повышает их шансы.  
    
3. **Мониторинг проиндексированных страниц**  
    В сочетании с Google Search Console можно отслеживать, какие URL из sitemap проиндексированы поисковиком Google.  
    
4. **Помощь при деиндексации**  
    Sitemap может помочь с деиндексацией определенных страниц сайта.  
    

> [!important]  
> Однако стоит отметить, что наличие sitemap не влияет напрямую на ранжирование страниц в поиске. Это не является ранжирующим фактором. Страницы с глубокой вложенностью или с низкой внутренней перелинковкой могут по-прежнему считаться малоценными поисковиками, даже если они присутствуют в sitemap. Поэтому sitemap лишь помогает поисковым роботам найти контент, но не гарантирует его высокий ранг в результатах поиска.  

### Когда sitemap нужен для сайта, а когда нет?

**Аргументы за:**

1. **У вас большой сайт  
      
    **Если на вашем сайте миллион и более страниц, то sitemap очень рекомендуется. Это поможет поисковым роботам быстрее находить и индексировать весь контент.
2. **У вас новый сайт  
      
    **Sitemap позволит поисковикам быстрее обнаружить и проиндексировать страницы сразу после запуска сайта.
3. **Вы часто меняете контент сайта  
      
    **Если контент на сайте регулярно обновляется, sitemap ускорит индексацию новых/измененных страниц.
4. **Вам нужно очень быстро индексировать свежий контент  
      
    **Особенно актуально, если ваш сайт участвует в Google Новостях. Sitemap обеспечит быструю индексацию новых страниц.

**С другой стороны, sitemap не обязателен для:**

1. Одностраничных сайтов-визиток
2. Портфолио-сайтов
3. Сайтов организаций
4. Небольших сайтов локального бизнеса
5. SaaS-приложений

Для относительно небольших и статичных сайтов sitemap может не потребоваться, так как поисковые роботы смогут обнаружить и проиндексировать контент без дополнительной подсказки. Но для крупных и часто обновляемых ресурсов наличие карты сайта весьма желательно.

### Рекомендации по созданию карты сайта

Логические:

- **Включай все важные страницы  
      
    **Убедись, что в sitemap включены все страницы с основным контентом, категории, теги, важные изображения и видео, которые ты хочешь, чтобы индексировали поисковые системы.
- **Исключай ненужные страницы  
      
    **Не включай в sitemap вспомогательные страницы (формы, аккаунты и т.п.), редиректы, страницы с ошибками, URL с параметрами/сессиями, сгенерированные фильтрацией, с других субдоменов, канонические страницы, страницы пагинации, дубликаты.
- **Не включай страницы с noindex  
      
    **Если страница помечена метатегом noindex или запрещена в robots.txt, не включай ее в sitemap.
- **Обновляй регулярно  
      
    **Убедись, что твой sitemap актуален - добавляй новые и удаляй устаревшие страницы, особенно для сайтов с динамическим контентом.
- **Информируй поисковые системы  
      
    **После создания/обновления сообщи поисковикам через их инструменты для вебмастеров. Это ускорит индексацию.

Технические:

- **Используй правильный формат  
      
    **Sitemap обычно создается в формате XML. Он должен быть валидным и соответствовать стандарту, чтобы поисковики могли его корректно прочитать.
- **Разделяй большие файлы  
      
    **Если количество URL превышает 50 000 или размер более 50 МБ, раздели sitemap на несколько частей. Создай индексный файл для ссылок на них.
- **Соблюдай правила оформления  
      
    **Используй правильную кодировку UTF-8, абсолютные URL, экранируй спецсимволы, следуй ограничениям по количеству URL и размеру файла.
- **Указывай частоту обновлений и приоритеты  
      
    **В XML-файле можно указать частоту обновления каждой страницы (<changefreq>) и ее относительный приоритет (<priority>). Это помогает поисковикам определить важность страниц.
- **Указывай дату последнего изменения  
      
    **Добавляй тег <lastmod> с датой последнего обновления страницы. Это подскажет поисковикам, когда нужно ее пересмотреть.

### Генерируем sitemap с помощью Django

1. **Первым шагом нам нужно установить django.contrib.sitemaps и django.contrib.sites**
    
    В settings.py добавьте 'django.contrib.sitemaps' и 'django.contrib.sites' в список INSTALLED_APPS:
    
    ```Python
    INSTALLED_APPS = [
        ...
        'django.contrib.sites',
        'django.contrib.sitemaps',
    ]
    ```
    
    Также задайте SITE_ID для указания сайта по умолчанию:
    
    ```Python
    SITE_ID = 1
    ```
    
    - `django.contrib.sitemaps` это встроенный в Django фреймворк для генерации карт сайтов (sitemap.xml) на основе моделей данных приложения. Он позволяет автоматически создавать XML-файл со списком URL сайта, который помогает поисковым роботам эффективно индексировать весь контент.
    - `django.contrib.sites` предназначен для работы с несколькими сайтами/доменами в одном Django-проекте. Он хранит информацию о доменах в базе данных. django.contrib.sitemaps использует данный модуль для того, чтобы формировать абсолютные URL в сгенерированном sitemap.xml, включая схему (http/https) и домен.
    - `SITE_ID` указывает, запись из таблицы сайтов должна использоваться для формирования абсолютных URL в sitemap.xml.
    
    После этого выполните миграции, чтобы создать таблицу сайтов:
    
    ```Plain
    python manage.py migrate
    ```
    
    Теперь в админ-панели в разделе "Сайты" вы увидите запись с id=1 и доменом example.com. Вы можете изменить эту запись, указав нужный вам домен. Он будет использоваться для построения абсолютных URL в sitemap.xml.
    
2. **Создаём файл с моделями для sitemap**
    
    Создайте файл, например `sitemaps.py`, в одном из ваших приложений и определите там классы, описывающие модели для sitemap:
    
    ```Python
    from django.contrib.sitemaps import Sitemap
    from blog.models import Entry
    
    
    class BlogSitemap(Sitemap):
        changefreq = "never"
        priority = 0.5
    
        def items(self):
            return Entry.objects.filter(is_draft=False)
    
        def lastmod(self, obj):
            return obj.pub_date
    ```
    
    - **Методы и атрибуты класса Sitemap.**
        - **items**
            - **Тип**: Метод.
            - Единственный обязательный метод, все остальные методы и атрибуты - опциональные.
            - **Аргументы**: Нет.
            - **Возвращает**: Последовательность или QuerySet объектов.
            - **Использование**: Возвращает набор объектов для включения в карту сайта. Это основной метод, который сообщает, какие объекты будут отображены в Sitemap.
        - **location**
            - **Тип**: Метод или атрибут.
            - **Аргументы (для метода)**: Один объект из `items()`.
            - **Возвращает**: Абсолютный путь (строка).
            - **Использование**: Указывает URL для каждого объекта. Если не указан, используется метод `get_absolute_url()` объекта. Используется для указания поисковикам, где именно находится каждый объект на сайте.
        - **lastmod**
            - **Тип**: Метод или атрибут.
            - **Аргументы (для метода)**: Один объект из `items()`.
            - **Возвращает**: `datetime`.
            - **Использование**: Указывает дату последнего изменения объекта. Это помогает поисковым системам определить, когда была последняя модификация страницы и следует ли её повторно индексировать.
        - **paginator**
            - **Тип**: Свойство.
            - **Аргументы**: Нет.
            - **Возвращает**: `Paginator` объект.
            - **Использование**: Разделяет Sitemap на страницы, если объектов много. Полезно для больших сайтов, чтобы избежать превышения лимита на количество URL в одной карте сайта.
        - **changefreq**
            - **Тип**: Метод или атрибут.
            - **Аргументы (для метода)**: Один объект из `items()`.
            - **Возвращает**: Строка.
            - **Использование**: Указывает частоту изменений объекта. Это помогает поисковым системам понять, как часто может изменяться контент на данной странице.
            - **Возможные значения**: 'always', 'hourly', 'daily', 'weekly', 'monthly', 'yearly', 'never'.
        - **priority**
            - **Тип**: Метод или атрибут.
            - **Аргументы (для метода)**: Один объект из `items()`.
            - **Возвращает**: Строка или число.
            - **Использование**: Указывает приоритет объекта. Это помогает поисковым системам определить важность страницы относительно других страниц на сайте.
            - **Примеры значений**: 0.4, 1.0. По умолчанию приоритет страницы равен 0.5.
        - **protocol**
            - **Тип**: Атрибут.
            - **Аргументы**: Нет.
            - **Возвращает**: Строка ('http' или 'https').
            - **Использование**: Определяет протокол для URL в Sitemap. Если не установлен, используется протокол, с которым был запрошен Sitemap.
        - **limit**
            - **Тип**: Атрибут.
            - **Аргументы**: Нет.
            - **Возвращает**: Целое число.
            - **Использование**: Ограничивает количество URL на каждой странице Sitemap. Значение не должно превышать 50000, что является максимальным значением по протоколу Sitemaps.
        - **i18n**
            - **Тип**: Атрибут.
            - **Аргументы**: Нет.
            - **Возвращает**: Булево значение.
            - **Использование**: Генерирует URL для всех языков, если `True`. Полезно для многоязычных сайтов.
        - **languages**
            - **Тип**: Атрибут.
            - **Аргументы**: Нет.
            - **Возвращает**: Последовательность языковых кодов.
            - **Использование**: Определяет языковые коды для генерации альтернативных ссылок при включенном `i18n`.
        - **alternates**
            - **Тип**: Атрибут.
            - **Аргументы**: Нет.
            - **Возвращает**: Булево значение.
            - **Использование**: Генерирует альтернативные ссылки на другие языковые версии URL при включенном `i18n`.
        - **x_default**
            - **Тип**: Атрибут.
            - **Аргументы**: Нет.
            - **Возвращает**: Булево значение.
            - **Использование**: Добавляет запись `hreflang="x-default"` в альтернативные ссылки, если `True`.
        - **get_latest_lastmod()**
            - **Тип**: Метод.
            - **Аргументы**: Нет.
            - **Возвращает**: `datetime`.
            - **Использование**: Возвращает самое позднее значение `lastmod` среди объектов из `items()`. Это помогает указать дату последнего изменения для всего Sitemap.
        - **get_languages_for_item(item)**
            - **Тип**: Метод.
            - **Аргументы**: Один объект из `items()`.
            - **Возвращает**: Последовательность языковых кодов.
            - **Использование**: Определяет языки, на которых отображается элемент. Полезно для многоязычных сайтов для указания языковых версий страницы.
3. **Добавляем sitemap в urls.py**
    
    В urls.py вашего проекта добавьте сэтап для sitemap:
    
    ```Python
    from django.contrib.sitemaps.views import sitemap
    from app.sitemaps import StaticViewSitemap, PostSitemap
    
    sitemaps = {
        'blog': BlogSitemap,
    }
    
    urlpatterns = [
        ...
        path('sitemap.xml', sitemap, {'sitemaps': sitemaps},
             name='django.contrib.sitemaps.views.sitemap')
    ]
    ```
    
    Здесь:
    
    - Импортируется представление sitemap
    - Создается словарь `sitemaps`, сопоставляющий короткие метки разделов ('blog') с соответствующими классами Sitemap
    - Добавляется путь 'sitemap.xml', указывающий на представление sitemap с аргументом {'sitemaps': sitemaps}
    - Задается имя пути 'django.contrib.sitemaps.views.sitemap'
    
    Эта конфигурация указывает Django формировать `sitemap.xml` при обращении клиента к `/sitemap.xml`.
    
    > [!important]  
    > Имя файла sitemap не имеет значения, но важно его расположение. Поисковые системы будут индексировать ссылки в вашей карте сайта только для текущего уровня URL и ниже. Например, если файл sitemap.xml находится в корневом каталоге, он может ссылаться на любой URL вашего сайта. Однако если ваша карта сайта находится в каталоге /content/sitemap.xml, она может ссылаться только на URL, начинающиеся с /content/.  
    

### Кэширование vs актуальность

Важно найти баланс между актуальностью карты сайта и её кэшированием. Актуальная карта сайта обеспечивает быстрое индексирование новых или обновленных страниц поисковыми системами, что критично для сайтов с частыми изменениями контента. Django позволяет уведомлять Google о таких изменениях с помощью `[ping_google()](https://docs.djangoproject.com/en/4.2/ref/contrib/sitemaps/#pinging-google)`, что помогает поддерживать индекс актуальным.

С другой стороны, кэширование карты сайта снижает нагрузку на сервер и предотвращает возможные атаки, что особенно полезно для крупных сайтов. Кэширование на разумный период, например, 24 часа, позволяет поддерживать карту сайта относительно свежей и снижать нагрузку на сервер. Комбинированный подход, при котором используется кэширование и уведомление Google при значительных изменениях, обеспечивает оптимальный баланс между производительностью и актуальностью данных.

### GenericSitemap

`GenericSitemap` — Вместо того чтобы вручную писать код для каждого элемента карты сайта, можно просто передать класс `GenericSitemap` словарь с необходимыми настройками.

**Как это работает**

1. **Настройки в словаре**: Вы создаете словарь, который содержит QuerySet (набор данных из базы данных), и указываете, какие данные нужно использовать. Например, вы можете выбрать все записи из таблицы блога.
2. **Поля даты**: Если у ваших объектов есть поле с датой (например, дата публикации), вы можете указать это поле в словаре. Это позволит автоматически заполнять атрибут `lastmod` (дата последнего изменения) в карте сайта.
3. **Дополнительные параметры**: Вы также можете указать такие параметры, как `priority` (приоритет), `changefreq` (частота изменений) и `protocol` (протокол, например, `http` или `https`). Эти параметры будут применены ко всем URL в карте сайта.

**Пример использования**

```Python
from django.contrib.sitemaps import GenericSitemap
from django.contrib.sitemaps.views import sitemap
from django.urls import path
from blog.models import Entry

info_dict = {
    "queryset": Entry.objects.all(),
    "date_field": "pub_date",
}

urlpatterns = [
    # some generic view using info_dict
    # ...
    # the sitemap
    path(
        "sitemap.xml",
        sitemap,
        {"sitemaps": {"blog": GenericSitemap(info_dict, priority=0.6)}},
        name="django.contrib.sitemaps.views.sitemap",
    ),
]
```

Можно использовать данный подход и для формирования карты сайта из нескольких моделей, но в таком случае, чтобы не произошло “раздувание” файла `urls.py` логикой, которая к маршрутам не очень-то и относится, лучше разделить её на два файла:

Пример `sitemaps.py`

```Python
from django.contrib.sitemaps import GenericSitemap
from blog.models import Entry, Author

entry_info_dict = {
    "queryset": Entry.objects.all(),
    "date_field": "pub_date",
}

author_info_dict = {
    "queryset": Author.objects.all(),
    "date_field": "updated_at",
}

sitemaps = {
    "entries": GenericSitemap(entry_info_dict, priority=0.6),
    "authors": GenericSitemap(author_info_dict, priority=0.5),
}
```

Пример `urls.py`

```Python
from django.contrib.sitemaps.views import sitemap
from django.urls import path
from .sitemaps import sitemaps

urlpatterns = [
    path(
        "sitemap.xml",
        sitemap,
        {"sitemaps": sitemaps},
        name="django.contrib.sitemaps.views.sitemap",
    ),
]
```

### Добавляем в sitemap статичные страницы

Иногда нужно, чтобы поисковые системы индексировали не только страницы с объектами (например, детали записей блога), но и статические страницы (например, "О нас", "Лицензия" и т.д.). Для этого можно явно указать URL-имена для этих представлений в методе `items` и использовать `reverse()` для получения URL в методе `location`.

```Python
# sitemaps.py
from django.contrib import sitemaps
from django.urls import reverse


class StaticViewSitemap(sitemaps.Sitemap):
    priority = 0.5
    changefreq = "daily"

    def items(self):
        return ["main", "about", "license"]

    def location(self, item):
        return reverse(item)


# urls.py
from django.contrib.sitemaps.views import sitemap
from django.urls import path

from .sitemaps import StaticViewSitemap
from . import views

sitemaps = {
    "static": StaticViewSitemap,
}

urlpatterns = [
    path("", views.main, name="main"),
    path("about/", views.about, name="about"),
    path("license/", views.license, name="license"),
    # ...
    path(
        "sitemap.xml",
        sitemap,
        {"sitemaps": sitemaps},
        name="django.contrib.sitemaps.views.sitemap",
    ),
]
```

### Разбор структуры файла sitemap

```XML
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:xhtml="http://www.w3.org/1999/xhtml">
    <url>
        <loc>http://example.com/post/ada_lovelace/</loc>
        <lastmod>2024-04-30</lastmod>
        <priority>0.7</priority>
    </url>
</urlset>
```

**Элементы**

1. **<urlset>**: Корневой элемент, содержит все URL-элементы.
    - `xmlns`: Пространство имен для схемы sitemap.
    - `xmlns:xhtml`: Пространство имен для xhtml.
2. **<url>**: Элемент, представляющий отдельный URL.
    - **<loc>**: Полный URL страницы.
    - **<lastmod>**: Дата последнего изменения страницы (опционально).
    - **<priority>**: Приоритет страницы (опционально), от 0.0 до 1.0.

<div class="page-break" style="page-break-before: always;"></div>
