Описание

dumpdata

loaddata

### Описание

**Fixtures** в Django — это способ сохранения и загрузки данных в базу данных. Они представляют собой файлы, содержащие данные для моделей, которые можно использовать для начального заполнения базы данных или для тестирования. Файлы фикстур могут быть в форматах JSON, XML или YAML.

**Преимущества использования фикстур:**

- **Повторяемость**: Фикстуры позволяют воспроизводить одно и то же состояние базы данных в различных окружениях (разработка, тестирование, производство).
- **Удобство тестирования**: Фикстуры облегчают настройку тестовой среды, обеспечивая предсказуемое состояние данных.
- **Легкость переноса данных**: С помощью фикстур можно легко перенести данные с одного сервера на другой или между различными базами данных.

**Примеры форматов фикстур:**

1. **JSON:**
    
    ```JSON
    [
        {
            "model": "app_name.modelname",
            "pk": 1,
            "fields": {
                "field1": "value1",
                "field2": "value2"
            }
        }
    ]
    ```
    
2. **XML:**
    
    ```XML
    <django-objects version="1.0">
        <object model="app_name.modelname" pk="1">
            <field name="field1" type="CharField">value1</field>
            <field name="field2" type="CharField">value2</field>
        </object>
    </django-objects>
    ```
    
3. **YAML:**
    
    ```YAML
    - model: app_name.modelname
      pk: 1
      fields:
        field1: value1
        field2: value2
    ```
    

### `dumpdata`

Команда `**dumpdata**` в Django используется для вывода данных из базы данных, связанных с указанными приложениями или моделями.

**Синтаксис и флаги**

`django-admin dumpdata [app_label[.ModelName] [app_label[.ModelName] ...]]`

1. **Вывод данных определенных приложений/моделей**
    - Если не указать имя приложения, будут выведены данные всех установленных приложений.
    - Можно указать одно или несколько имен приложений (через пробел), чтобы вывести только их данные.
    - Также можно указать комбинацию `app_label.ModelName` для вывода данных конкретных моделей.
2. **Формат вывода**
    - По умолчанию используется формат JSON.
    - Можно указать другой формат с помощью `--format=FORMAT` (поддерживаемые форматы: XML, YAML и др.)
3. **Уровень детализации**
    - `--indent=INDENT` позволяет задать количество пробелов для отступов в выводе (по умолчанию все на одной строке).
4. **Исключение приложений/моделей**
    - `--exclude=app_label` или `--exclude=app_label.ModelName` исключает указанные приложения/модели из вывода. Короткий вариант флага `-e`. Если нужно исключить несколько приложений/моделей, нужно перед каждой из них указать флаг `--exclude`.
5. **Выбор базы данных**
    - `--database=DATABASE` позволяет указать базу данных для выгрузки (по умолчанию default).
6. **Обработка внешних ключей**
    - `--natural-foreign` Использует метод модели `natural_key()` для сериализации любых связей внешних ключей и многих ко многим отношений. Важно, метод `natural_key()` должен быть предварительно прописан для каждой модели разработчиком, иначе вместо натурального ключа (комбинации заранее определённых полей), будет использован первичный ключ, что полностью обнуляет смысл использования данного флага)
    - Рекомендуется для объектов `Permission` и `ContentType`. Встроенные модели `Permission` и `ContentType` из Django уже имеют определенные методы `natural_key()`, поэтому вы можете использовать флаг `--natural-foreign` с этими моделями без необходимости добавлять что-то дополнительно.
    - `--natural-primary` пропускает первичный ключ в сериализованных данных этого объекта, так как он может быть рассчитан при десериализации.
7. **Выбор объектов по первичным ключам**
    - `--pks=PRIMARY_KEYS` выгружает только объекты, указанные в виде списка первичных ключей, разделенных запятыми. Этот параметр доступен только при выгрузке одной модели. По умолчанию выгружаются все записи модели.
8. **Вывод в файл**
    - `--output=OUTPUT` или `-o=OUTPUT` записывает сериализованные данные в файл вместо вывода в stdout (по умолчанию).
    - При использовании этой опции и `--verbosity > 0` отображается прогресс-бар.
9. **Сжатие fixtures**
    - Можно сжать выходной файл, добавив к имени файла расширения `.bz2`, `.gz`, `.lzma` или `.xz`.
10. **Использование базового менеджера**
    - `-all` или `-a` заставляет dumpdata использовать базовый менеджер Django (Django's base manager) при выборе объектов для выгрузки.  
        - Если вы используете кастомный менеджер по умолчанию, который фильтрует или изменяет выборку записей, то без этого флага некоторые объекты могут не попасть в fixtures.  
        - С этим флагом будут выгружены все записи, игнорируя любые фильтры и модификации кастомного менеджера.  
        - Это помогает избежать потери данных при выгрузке fixtures, если вы используете нестандартную логику в менеджерах моделей.  
        

Итого, чтобы сохранить все наши данные в fixture, выполняем следующую команду:

```Shell
python -Xutf8 manage.py dumpdata --indent=2 --natural-foreign -o db.json
```

Из важного:

- Флаг `-Xutf8` добавлен для того, чтобы вывод в файл json был в кодировке utf8.
- Флаг `--natural-foreign` добавлен, чтобы не было проблем при переносе данных о разрешениях и contenttype в другую БД.

### `loaddata`

Команда `loaddata` в Django используется для поиска и загрузки содержимого указанных фикстур в базу данных.

**Синтаксис и флаги**

`django-admin loaddata fixture [fixture ...]`

1. **Загрузка данных из фикстур**
    - Вы можете указать одну или несколько фикстур, данные из которых будут загружены в базу данных.
    - Если вы используете дефолтную базу данных, данные будут загружены в неё, если не указано иное.
2. **Выбор базы данных**
    - `--database=DATABASE` позволяет указать, в какую базу данных будут загружены данные. По умолчанию используется база данных `default`.
3. **Игнорирование несуществующих полей и моделей**
    - `--ignorenonexistent` или `-i` игнорирует поля и модели, которые могут быть удалены с момента создания фикстуры. Это полезно при загрузке старых фикстур в обновленные схемы базы данных.
4. **Указание приложения для поиска фикстур**
    - `--app=APP_LABEL` позволяет указать одно приложение, в котором будут искаться фикстуры, вместо поиска во всех приложениях.
5. **Формат сериализации**
    - `--format=FORMAT` указывает формат сериализации для фикстур, читаемых из `stdin`. Поддерживаемые форматы включают JSON, XML и YAML.
6. **Загрузка фикстур из stdin**
    - Можно использовать дефис в качестве имени фикстуры для загрузки данных из `stdin`.
    - Загрузка из `stdin` полезна при использовании перенаправления стандартного ввода и вывода (то есть мы не сохраняем фикстуру в промежуточном файле, а сразу выгружаем её в нужную БД). Например:
        
        ```Shell
        python manage.py dumpdata --format=json --database=test app_label.ModelName | python manage.py loaddata --format=json --database=prod -
        ```
        
7. **Исключение приложений и моделей**
    - `--exclude=EXCLUDE` или `-e=EXCLUDE` исключает загрузку фикстур из указанных приложений и/или моделей (в формате `app_label` или `app_label.ModelName`). Для исключения нескольких приложений или моделей необходимо несколько раз указать флаг `--exclude`.

Команда для выгрузки fixture в БД по умолчанию:

```Shell
python manage.py loaddata db.json
```

<div class="page-break" style="page-break-before: always;"></div>
