MEDIA_ROOT

Классы models.FileField и models.ImageField

Алгоритм загрузки файлов в связке - модель + форма + БД

Подробнее про параметр upload_to

### MEDIA_ROOT

Переменная `MEDIA_ROOT` в Django используется для указания абсолютного пути к директории, в которой будут сохраняться пользовательские медиафайлы, такие как изображения, аудио или видео, загруженные через веб-приложение.

Основные функции `MEDIA_ROOT`:

1. **Хранение пользовательских медиафайлов**: Когда пользователь загружает файл через модель с `FileField` или `ImageField`, этот файл сохраняется в директории, указанной в `MEDIA_ROOT`. Это позволяет отделить пользовательский контент от статических файлов приложения.
2. **Построение корректных URL**: Вместе с `MEDIA_URL` переменная `MEDIA_ROOT` используется Django для построения правильных URL-адресов для доступа к загруженным медиафайлам.
3. **Безопасность**: Использование `MEDIA_ROOT` помогает обеспечить, чтобы пользовательские файлы не были доступны из директорий, содержащих критичные для приложения файлы.

### Классы models.FileField и models.ImageField

1. **models.FileField**:
    - `models.FileField` является полем модели, которое позволяет сохранять файлы, загружаемые пользователями.
    - Это поле принимает файл в качестве входных данных и сохраняет его на сервере.
    - Основные параметры `FileField`:
        - `upload_to`: определяет путь относительно `MEDIA_ROOT`, куда будут загружаться файлы.
        - `max_length`: определяет максимальную длину пути к файлу (по умолчанию 100 символов).
        - `storage`: позволяет указать кастомный storage, отличный от стандартного.
        - `null`, `blank`, `default`: обычные параметры для всех полей модели.
    - `FileField` может использоваться для загрузки любых типов файлов, таких как документы, аудио, видео и т.д.
    - При сохранении модели с `FileField`, файл загружается на сервер, а в базу данных сохраняется путь к этому файлу.
2. **models.ImageField**:
    - `models.ImageField` является специализированной версией `FileField`, предназначенной для загрузки и сохранения изображений.
    - Помимо параметров `FileField`, `ImageField` также имеет дополнительные параметры:
        - `height_field`: позволяет сохранять высоту изображения в другом поле модели.
        - `width_field`: позволяет сохранять ширину изображения в другом поле модели.
        - `max_length`: определяет максимальную длину пути к файлу (по умолчанию 100 символов).
    - `ImageField` проверяет, что загружаемый файл является корректным изображением, и автоматически сохраняет его размеры в базе данных, если использованы `height_field` и `width_field`.
    - Как и `FileField`, `ImageField` сохраняет путь к файлу в базе данных, а сам файл загружается на сервер.
    - `ImageField` часто используется для загрузки профильных фотографий, изображений товаров, и других визуальных компонентов приложения.

### Алгоритм загрузки файлов в связке - модель + форма + БД

1. **Задаём переменную MEDIA_ROOT**:
    
    - `MEDIA_ROOT` - это путь к директории, где будут сохраняться загруженные пользователем файлы.
    - Мы устанавливаем эту переменную в `settings.py` Django-проекта, чтобы указать корневую директорию для медиафайлов.
    - Это необходимо, чтобы Django мог правильно работать с загруженными файлами и строить корректные URL-адреса для доступа к ним.
    
    ```Python
    # settings.py
    
    # Директория для хранения медиафайлов
    MEDIA_ROOT = BASE_DIR / 'media'
    MEDIA_URL = '/media/'
    ```
    
2. **Добавляем поле для файла в модель**:
    
    - На примере модели `Book` добавляем поле `image` типа `models.ImageField`, которое будет хранить путь к загруженному изображению.
    - Также в модели есть другие поля, такие как `title`, `author` (внешний ключ) и `year`.
    - После создания (или изменения) модели не забываем про создание и применение миграций!
    
    ```Python
    # models.py
    from django.db import models
    
    class Book(models.Model):
        title = models.CharField(max_length=100)
        author = models.ForeignKey('Author', on_delete=models.CASCADE)
        image = models.ImageField(upload_to='book_covers', null=True, blank=True)
        year = models.IntegerField()
    
    class Author(models.Model):
        name = models.CharField(max_length=100)
    ```
    
3. **Используем эту модель в форме**:
    
    - Создаём форму `BookForm`, наследуясь от `ModelForm` и включаем в неё поле `image`.
    - Это позволит пользователю загружать изображение через форму при создании или редактировании книги.
    
    ```Python
    # forms.py
    from django import forms
    from .models import Book
    
    class BookForm(forms.ModelForm):
        class Meta:
            model = Book
            fields = ['title', 'author', 'image', 'year']
    ```
    
4. **Корректно прописываем шаблон, для загрузки файлов и других данных формы**:
    
    - В HTML-шаблоне формы добавляем атрибут `enctype="multipart/form-data"` в тег `<form>`.
    - Это необходимо, чтобы браузер мог правильно передавать файлы на сервер вместе с другими данными формы.
    
    ```HTML
    <!-- book_form.html -->
    {% extends 'base.html' %}
    
    {% block content %}
      <h1>Добавить книгу</h1>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Сохранить</button>
      </form>
    {% endblock %}
    ```
    
5. **Корректно прописываем функцию представление с сохранением полученных данных в форму**:
    
    - В представлении (view) обрабатываем запрос на создание книги.
    - Создаём экземпляр формы `BookForm` с данными, полученными из запроса.
    - Если форма валидна, сохраняем книгу в базу данных, а файл изображения - в директорию, указанную в `MEDIA_ROOT`.
    - Затем, при необходимости, можем получить URL-адрес загруженного изображения, используя `instance.image.url`.
    
    ```Python
    # views.py
    from django.shortcuts import render, redirect
    from .forms import BookForm
    from .models import Book
    
    def create_book(request):
        if request.method == 'POST':
            form = BookForm(request.POST, request.FILES)
            if form.is_valid():
                book = form.save()
                return redirect('book_detail', pk=book.pk)
        else:
            form = BookForm()
        return render(request, 'book_form.html', {'form': form})
    ```
    

### Подробнее про параметр `upload_to`

Параметр `upload_to` определяет относительный путь, где будут сохраняться загруженные файлы внутри `MEDIA_ROOT` директории. Он может принимать различные значения:

1. **Строка с относительным путём**:
    - Простой относительный путь, например, `'photos/'` - файлы будут сохраняться в директории `media/photos/`.
    - Можно использовать динамические переменные, чтобы структурировать файлы по различным критериям:
        - `'photos/%Y/%m/%d/'` - файлы будут разделены по году, месяцу и дню.
        - `'user_photos/%username%/'` - файлы будут разделены по имени пользователя.
2. **Функция, возвращающая путь**:
    - Функция, принимающая `instance` модели и `filename` загружаемого файла, и возвращающая относительный путь.
    - Например, `def user_directory_path(instance, filename):` возвращает `'user_{0}/{1}'.format(instance.user.id, filename)`.

Некоторые популярные динамические переменные, которые можно использовать в `upload_to`:

- `%Y` - год (4 цифры)
- `%m` - месяц (2 цифры)
- `%d` - день (2 цифры)
- `%H` - час (2 цифры)
- `%M` - минута (2 цифры)
- `%S` - секунда (2 цифры)
- `%username%` - имя пользователя, связанного с моделью
- `%user_id%` - ID пользователя, связанного с моделью

<div class="page-break" style="page-break-before: always;"></div>
