Описание

Наследование

DeletionMixin

BaseDeleteView

Краткое summery

### Описание

`DeleteView` - это класс-представление в Django, который предоставляет функционал для удаления существующего объекта из базы данных. Когда пользователь переходит по URL, связанному с `DeleteView`, ему отображается страница подтверждения удаления. Если пользователь подтверждает удаление (обычно через POST-запрос), объект удаляется из базы данных.

Использование класса `DeleteView` имеет несколько преимуществ:

1. **Меньше кода**: Мы можем создать полнофункциональное представление для удаления объекта всего за несколько строк кода.
2. **Встроенные шаблоны**: `DeleteView` автоматически использует шаблон с суффиксом `_confirm_delete` для отображения страницы подтверждения удаления.
3. **Проверка подтверждения**: `DeleteView` требует POST-запрос для фактического удаления объекта, что защищает от случайных удалений.

**Пример использования DeleteView**

Давайте посмотрим на пример использования `DeleteView` для удаления объекта модели `Author`.

```Python
from django.urls import reverse_lazy
from django.views.generic import DeleteView
from myapp.models import Author

class AuthorDeleteView(DeleteView):
    model = Author
    success_url = reverse_lazy("author-list")
```

В этом примере мы создаем класс `AuthorDeleteView`, который наследуется от `DeleteView`. Мы указываем модель `Author` и URL для перенаправления после успешного удаления (`success_url`).

Теперь создадим шаблон `myapp/author_confirm_delete.html` для страницы подтверждения удаления:

```HTML
<form method="post">{% csrf_token %}
    <p>Вы уверены, что хотите удалить "{{ object }}"?</p>
    {{ form }}
    <input type="submit" value="Подтвердить">
</form>
```

Также нужно не забыть связать класс AuthorDeleteView с URL-маршрутом и добавить кнопку для перехода по этому маршруту на страницу с отображением автора (или списка авторов).

При GET-запросе к `AuthorDeleteView` будет отображаться эта страница подтверждения. Когда пользователь нажмет кнопку "Подтвердить", будет отправлен POST-запрос, и объект `Author` будет удален из базы данных. После этого пользователь будет перенаправлен на страницу списка авторов (`success_url`).

### Наследование

- [[i-d. Класс DetailView (+ SingleObjectTemplateResponseMixin, SingleObjectMixin, BaseDetailView)]]:
    - Этот миксин расширяет функциональность `TemplateResponseMixin` для отображения одиночного объекта.
    - Он предоставляет метод `get_template_names()`, который возвращает список имен шаблонов для рендеринга страницы подтверждения удаления.
    - Наследуется от [[i-b. Классы TemplateView, ContextMixin, TemplateResponseMixin]]:
        - Этот миксин предоставляет методы для рендеринга шаблонов и работы с контекстом.
        - Например, метод `render_to_response()` отвечает за формирование и возврат HTTP-ответа с отрендеренным шаблоном.
- `BaseDeleteView`:
    - Этот базовый класс предоставляет основную функциональность для удаления объектов.
    - Он наследуется от `DeletionMixin` и `FormMixin`.
        - `DeletionMixin`:
            - Этот миксин добавляет метод `delete()` для обработки POST-запросов на удаление объекта.
            - Он также предоставляет метод `post()`, который вызывает `delete()` после успешной валидации формы.
        - [[i-e. Класс FormView (+ FormMixin, ProcessFormView, BaseFormView)]]:
            - Этот миксин предоставляет дополнительные методы и атрибуты для работы с формами, такие как `get_form()`, `form_valid()`, `form_invalid()` и другие.
            - Он также наследуется от `ContextMixin`, который предоставляет методы для работы с контекстом шаблона.
    - `BaseDeleteView` также наследуется от [[i-d. Класс DetailView (+ SingleObjectTemplateResponseMixin, SingleObjectMixin, BaseDetailView)]]:
        - Этот базовый класс предоставляет основную функциональность для отображения страницы с детальной информацией об объекте.
        - Он наследуется от `SingleObjectMixin` и `View`.
            - [[i-d. Класс DetailView (+ SingleObjectTemplateResponseMixin, SingleObjectMixin, BaseDetailView)]]:
                - Этот миксин предоставляет методы и атрибуты для работы с одиночным объектом модели.
                - Он добавляет методы `get_object()`, `get_queryset()`, `get_context_object_name()` и другие.
            - [[i-a. Базовый класс представлений - View]]:
                - Это базовый класс для всех классов-представлений в Django.
                - Он предоставляет основные методы, такие как `dispatch()`, `http_method_not_allowed()`, `options()` и другие.

### **DeletionMixin**

`DeletionMixin` - это миксин, который предоставляет возможность удаления объектов в представлениях Django. Он содержит методы и атрибуты, необходимые для обработки запросов на удаление и перенаправления после успешного удаления. Давайте разберем его реализацию.

```Python
class DeletionMixin:
    """Provide the ability to delete objects."""

    success_url = None
```

- Атрибут `success_url` определяет URL, на который будет выполнено перенаправление после успешного удаления объекта. Если `success_url` не указан, будет вызвано исключение `ImproperlyConfigured`.

```Python
def delete(self, request, *args, **kwargs):
    """
    Call the delete() method on the fetched object and then redirect to the
    success URL.
    """
    self.object = self.get_object()
    success_url = self.get_success_url()
    self.object.delete()
    return HttpResponseRedirect(success_url)
```

- Метод `delete()` выполняет удаление объекта и перенаправляет пользователя на `success_url`. Вот что происходит внутри этого метода:
    1. Вызывается метод `self.get_object()`, чтобы получить объект, который нужно удалить. Этот метод обычно наследуется из `SingleObjectMixin` и возвращает объект на основе переданных параметров (например, `pk` или `slug`).
    2. Вызывается метод `self.get_success_url()`, чтобы получить URL для перенаправления после удаления. Об этом методе мы поговорим чуть позже.
    3. Вызывается метод `delete()` у полученного объекта (`self.object.delete()`), чтобы удалить его из базы данных.
    4. Возвращается `HttpResponseRedirect` с полученным `success_url`, чтобы перенаправить пользователя на соответствующую страницу.

```Python
def post(self, request, *args, **kwargs):
    return self.delete(request, *args, **kwargs)
```

- Метод `post()` добавлен для поддержки браузеров, которые принимают только GET и POST запросы. Он просто вызывает метод `delete()` при получении POST-запроса на удаление.

```Python
def get_success_url(self):
    if self.success_url:
        return self.success_url.format(**self.object.__dict__)
    else:
        raise ImproperlyConfigured("No URL to redirect to. Provide a success_url.")
```

- Метод `get_success_url()` позволяет задавать динамические URL для перенаправления после успешного удаления объекта. Вы можете использовать форматирование строк словаря для подстановки значений полей удаленного объекта в URL.
    
    Например, предположим, что у нас есть модель `Comment`, которая связана с моделью `Post` через внешний ключ `post`. После удаления комментария мы хотим перенаправить пользователя на страницу соответствующего поста. Вот как мы можем это сделать:
    
    ```Python
    class CommentDeleteView(DeleteView):
        model = Comment
        success_url = "/posts/{post_id}/"
    ```
    
    В этом примере мы используем `success_url="/posts/{post_id}/"`. После удаления комментария `DeletionMixin` автоматически подставит значение поля `post_id` удаленного комментария в этот URL. Таким образом, пользователь будет перенаправлен на страницу поста, к которому принадлежал удаленный комментарий.
    
    Если `success_url` не указан, то будет вызвано исключение `ImproperlyConfigured` с сообщением о том, что нужно указать URL для перенаправления.
    

Таким образом, `DeletionMixin` предоставляет основную функциональность для удаления объектов в представлениях. Он обрабатывает запросы на удаление, выполняет само удаление и перенаправляет пользователя на указанный `success_url`. Вы можете использовать этот миксин в своих представлениях, наследуясь от него и указывая необходимые атрибуты, такие как `model` и `success_url`.

### BaseDeleteView

Класс `BaseDeleteView` является базовым классом для представлений, которые занимаются удалением объектов. Он объединяет функциональность нескольких миксинов и базовых классов, чтобы предоставить полноценное представление для удаления объектов.

Давайте разберем его реализацию чтобы понять, что происходит внутри этого класса:

```Python
class BaseDeleteView(DeletionMixin, FormMixin, BaseDetailView):
    """
    Base view for deleting an object.

    Using this base class requires subclassing to provide a response mixin.
    """

    form_class = Form
```

`BaseDeleteView` наследуется от трех миксинов и базовых классов:

1. `DeletionMixin`: Предоставляет методы для удаления объектов, такие как `delete()` и `post()`.
2. `FormMixin`: Добавляет функциональность для работы с формами, включая методы `get_form()`, `form_valid()` и `form_invalid()`.
3. `BaseDetailView`: Базовый класс для представлений, которые отображают детальную информацию об одном объекте.

`form_class` - класс формы, которая будет использоваться для подтверждения запроса. По умолчанию django.forms.Form, что приводит к созданию пустой формы, которая всегда является валидной.

Предоставив свой собственный подкласс Form, вы можете добавить дополнительные требования, такие как, например, флажок подтверждения.

```Python
def post(self, request, *args, **kwargs):
# Set self.object before the usual form processing flow.# Inlined because having DeletionMixin as the first base, for# get_success_url(), makes leveraging super() with ProcessFormView# overly complex.
    self.object = self.get_object()
    form = self.get_form()
    if form.is_valid():
        return self.form_valid(form)
    else:
        return self.form_invalid(form)
```

- Метод `post()` обрабатывает POST-запросы на удаление объекта. Вот что происходит внутри этого метода:
    1. Получаем удаляемый объект с помощью метода `self.get_object()` и сохраняем его в `self.object`. Это необходимо сделать до обработки формы, чтобы объект был доступен в методе `form_valid()`.
    2. Получаем экземпляр формы с помощью метода `self.get_form()`, унаследованного от `FormMixin`.
    3. Проверяем, валидна ли форма. Если форма валидна, вызываем метод `self.form_valid(form)`, который выполнит удаление объекта. Если форма не валидна, вызываем метод `self.form_invalid(form)`, который вернет ответ с ошибками формы.

```Python
def form_valid(self, form):
    success_url = self.get_success_url()
    self.object.delete()
    return HttpResponseRedirect(success_url)
```

- Метод `form_valid()` вызывается, когда форма прошла валидацию. Здесь происходит удаление объекта и перенаправление на `success_url`:
    
    1. Получаем URL для перенаправления после успешного удаления с помощью метода `self.get_success_url()`, унаследованного от `DeletionMixin`.
    2. Удаляем объект с помощью метода `self.object.delete()`.
    3. Возвращаем `HttpResponseRedirect` с полученным `success_url`, чтобы перенаправить пользователя на соответствующую страницу.
    
    Стоит отметить, что текущая реализация `form_valid()` в `BaseDeleteView` дублирует логику метода `delete()` . Это может быть сделано для большей ясности и явного указания на то, что происходит при успешной валидации формы удаления.
    

Таким образом, `BaseDeleteView` предоставляет базовую функциональность для представлений удаления объектов. Он объединяет возможности работы с формами, отображения детальной информации об объекте и непосредственно удаления объекта. При создании своих представлений удаления, вы можете наследоваться от `BaseDeleteView` и переопределять атрибуты и методы по своему усмотрению, например, указывать свой класс формы, шаблон или переопределять метод `form_valid()` для добавления дополнительной логики.

### Краткое summery

1. `model` - атрибут, указывающий на модель Django, объекты которой будут удаляться через представление. Этот атрибут является обязательным, если не переопределен метод `get_queryset()`.
2. `template_name` - имя шаблона, который будет использоваться для рендеринга страницы подтверждения удаления. Если не указано, Django будет использовать шаблон по умолчанию на основе имени класса представления и суффикса `_confirm_delete.html`.
3. `success_url` - URL-адрес, на который будет выполнено перенаправление после успешного удаления объекта. Может быть задан как атрибут класса или определен динамически путем переопределения метода `get_success_url()`.
4. `object` - локальная переменная представления, которая будет содержать удаляемый объект. Задается автоматически при вызове метода `get_object()`.
5. `get_object(queryset=None)` - метод, который возвращает объект, подлежащий удалению. По умолчанию использует атрибуты `model` и `queryset` для получения объекта. Может быть переопределен для изменения логики получения объекта.
6. `get_queryset()` - метод, который возвращает queryset, используемый для получения удаляемого объекта. По умолчанию возвращает все объекты модели, указанной в атрибуте `model`. Может быть переопределен для изменения логики получения queryset.
7. `get_context_data(**kwargs)` - метод, который возвращает словарь контекста, передаваемый в шаблон. По умолчанию включает удаляемый объект под ключом `object`. Может быть переопределен для добавления дополнительных данных в контекст.
8. `form_valid(form)` - метод, который вызывается при успешной валидации формы подтверждения удаления. По умолчанию выполняет удаление объекта и перенаправляет на `success_url`. Согласно предупреждению в классе BaseDeleteView, любая пользовательская логика удаления должна быть перемещена из метода `delete()` в `form_valid()`, чтобы обеспечить правильную обработку POST-запросов через `FormMixin`.
9. `delete(request, *args, **kwargs)` - метод, который выполняет удаление объекта и перенаправляет на `success_url`. Вызывается при POST-запросе, если форма подтверждения удаления прошла валидацию.
10. `post(request, *args, **kwargs)` - метод, который обрабатывает POST-запросы. Получает удаляемый объект, проверяет валидацию формы подтверждения удаления и вызывает метод `delete()` при успешной валидации. Если форма не прошла валидацию, возвращает ответ с ошибками формы.
11. `get_success_url()` - метод, который возвращает URL-адрес для перенаправления после успешного удаления объекта. По умолчанию возвращает значение атрибута `success_url`. Может быть переопределен для динамического определения URL-адреса.

Эти атрибуты и методы являются основными для работы представления `DeleteView`. Они обеспечивают получение удаляемого объекта, рендеринг страницы подтверждения удаления, обработку POST-запросов на удаление и перенаправление после успешного удаления. При необходимости вы можете переопределить или расширить эти атрибуты и методы в своих представлениях-наследниках для настройки поведения удаления объектов.

<div class="page-break" style="page-break-before: always;"></div>
