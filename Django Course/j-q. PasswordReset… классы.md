PasswordResetView

PasswordResetDoneView

PasswordResetConfirmView

PasswordResetCompleteView

Резюме по участию классов в процедуре сброса пароля

### PasswordResetView

**PasswordResetView** - это класс, который позволяет пользователю сбросить свой пароль, сгенерировав одноразовую ссылку для сброса пароля и отправив ее на зарегистрированный email пользователя.

**Основные преимущества использования PasswordResetView:**

1. **Готовая функциональность сброса пароля**  
    PasswordResetView предоставляет готовую страницу и логику для сброса пароля пользователя по email, избавляя от необходимости реализовывать это вручную.  
    
2. **Обеспечение безопасности**  
    Представление учитывает ряд условий безопасности:  
    - Письмо отправляется только если email существует, пользователь активен и у него есть действующий пароль.
    - При невыполнении условий пользователь не получает никаких сообщений об ошибках, предотвращая утечку информации потенциальным злоумышленникам.
    - Представление decorated защитой `csrf_protect`.

**Пример использования**

```Python
from django.contrib.auth.views import PasswordResetView, PasswordResetDoneView, PasswordResetConfirmView, PasswordResetCompleteView

urlpatterns = [
    path('reset/', PasswordResetView.as_view(), name='password_reset'),
    path('reset/done/', PasswordResetDoneView.as_view(), name='password_reset_done'),
    path('reset/<uidb64>/<token>/', PasswordResetConfirmView.as_view(), name='password_reset_confirm'),
    path('reset/complete/', PasswordResetCompleteView.as_view(), name='password_reset_complete'),
]
```

**Контекст шаблона письма:**

- `email` - email пользователя
- `user` - текущий пользователь User
- `site_name`, `domain` - данные текущего сайта
- `uid` - закодированный в base64 первичный ключ пользователя
- `token` - токен для проверки валидности ссылки сброса
- `protocol` - http или https

**Наследование**

PasswordResetView наследуется от:

- [[j-m. PasswordChangeView, PasswordChangeDoneView, PasswordContextMixin]] - добавляет переменную `title` в контекст шаблона
- [[i-e. Класс FormView (+ FormMixin, ProcessFormView, BaseFormView)]] - базовое представление для обработки форм

**Атрибуты класса и их значения по умолчанию:**

1. `template_name = "registration/password_reset_form.html"`  
    Путь к шаблону страницы запроса сброса пароля.  
    
2. `form_class = PasswordResetForm`  
    Форма для получения email пользователя. По умолчанию  
    `PasswordResetForm`.
3. `email_template_name = "registration/password_reset_email.html"`  
    Шаблон для генерации тела письма со ссылкой сброса пароля.  
    
4. `subject_template_name = "registration/password_reset_subject.txt"`  
    Шаблон для темы письма сброса пароля.  
    
5. `token_generator = default_token_generator`  
    Экземпляр класса для проверки одноразового токена в ссылке. По умолчанию  
    `default_token_generator`.
6. `success_url = reverse_lazy("password_reset_done")`  
    URL для редиректа после успешного запроса на сброс пароля.  
    
7. `html_email_template_name = None`  
    Шаблон для генерации HTML версии письма. По умолчанию не используется.  
    
8. `from_email = None`  
    От какого email отправлять письма. По умолчанию используется  
    `DEFAULT_FROM_EMAIL` из настроек.
9. `extra_email_context = None`  
    Дополнительные данные контекста для шаблона письма.  
    

**Методы класса:**

1. `dispatch(self, *args, **kwargs)`  
    Декорирован  
    `csrf_protect`. Вызывает метод `dispatch` родительского класса.
2. `form_valid(self, form)`  
    Вызывается при успешной валидации формы сброса пароля. Передает ряд параметров в  
    `form.save()` для отправки письма, такие как `use_https`, `token_generator`, `email_template_name` и др. Затем вызывает `form_valid` родительского класса.

### PasswordResetDoneView

**PasswordResetDoneView** - это класс, который отображает страницу, показываемую после того, как пользователю была отправлена ссылка для сброса пароля по электронной почте. Это представление вызывается по умолчанию, если `PasswordResetView` не имеет явно установленного `success_url`.

**Основные характеристики PasswordResetDoneView:**

1. **Информирование пользователя**  
    PasswordResetDoneView служит для информирования пользователя о том, что ему была отправлена ссылка для сброса пароля по электронной почте. Это дает пользователю понимание следующих шагов для восстановления пароля.  
    
2. **Простота использования**  
    Для использования PasswordResetDoneView достаточно просто указать его в URL-конфигурации приложения. Представление уже имеет необходимые настройки по умолчанию.  
    
3. **Переопределение шаблона**  
    При необходимости можно легко переопределить шаблон страницы, отображаемой PasswordResetDoneView, указав путь к нему в атрибуте  
    `template_name`.

**Наследование**

PasswordResetDoneView наследуется от:

- [[j-m. PasswordChangeView, PasswordChangeDoneView, PasswordContextMixin]] - добавляет переменную `title` в контекст шаблона.
- [[i-b. Классы TemplateView, ContextMixin, TemplateResponseMixin]] - базовое представление для отображения шаблона страницы.

**Атрибуты класса и их значения по умолчанию:**

1. `template_name = "registration/password_reset_done.html"`  
    Путь к шаблону страницы, отображаемой после отправки ссылки сброса пароля.  
    
2. `title = _("Password reset sent")`  
    Заголовок страницы. Значение подготавливается для интернационализации с помощью функции  
    `_()`.

**Особенности работы**

Важно отметить, что даже если указанный адрес электронной почты не существует в системе, пользователь неактивен или имеет непригодный для использования пароль, пользователь все равно будет перенаправлен на эту страницу, но электронное письмо отправлено не будет. Это сделано для предотвращения утечки информации о существовании электронных адресов в системе.

### PasswordResetConfirmView

**PasswordResetConfirmView** - это класс, который отображает форму для ввода нового пароля при сбросе пароля пользователя. Он используется после того, как пользователь перешел по ссылке из письма для сброса пароля.

**Основные характеристики PasswordResetConfirmView:**

1. **Проверка валидности ссылки**  
    PasswordResetConfirmView проверяет валидность ссылки для сброса пароля на основе переданных в URL параметров  
    `uidb64` (закодированный в base64 идентификатор пользователя) и `token` (токен для проверки валидности ссылки).
2. **Отображение формы для ввода нового пароля**  
    Если ссылка валидна, PasswordResetConfirmView отображает форму  
    `SetPasswordForm` для ввода нового пароля пользователем.

**Контекст шаблона:**

- `form` - форма для установки нового пароля (по умолчанию `SetPasswordForm`)
- `validlink` - флаг, указывающий, является ли ссылка (комбинация `uidb64` и `token`) валидной и неиспользованной

**Наследование**

PasswordResetConfirmView наследуется от:

- [[j-m. PasswordChangeView, PasswordChangeDoneView, PasswordContextMixin]] - добавляет переменную `title` в контекст шаблона
- [[i-e. Класс FormView (+ FormMixin, ProcessFormView, BaseFormView)]] - базовое представление для обработки форм

**Атрибуты класса и их значения по умолчанию:**

1. `template_name = "registration/password_reset_confirm.html"`  
    Путь к шаблону страницы подтверждения сброса пароля.  
    
2. `token_generator = default_token_generator`  
    Экземпляр класса для проверки токена сброса пароля. По умолчанию  
    `default_token_generator`.
3. `form_class = SetPasswordForm`  
    Форма, которая будет использоваться для установки нового пароля. По умолчанию  
    `SetPasswordForm`.
4. `success_url = reverse_lazy("password_reset_complete")`  
    URL для перенаправления после успешного сброса пароля.  
    
5. `post_reset_login = False`  
    Флаг, указывающий, должен ли пользователь быть автоматически аутентифицирован после успешного сброса пароля.  
    
6. `post_reset_login_backend = None`  
    Путь к бэкенду аутентификации, который будет использоваться, если  
    `post_reset_login` имеет значение `True`.
7. `reset_url_token = "set-password"`  
    Токен, отображаемый как компонент URL сброса пароля.  
    

**Методы и декораторы:**

1. `dispatch(self, *args, **kwargs)`  
    Метод проверяет наличие параметров  
    `uidb64` и `token` в URL. Если пользователь и токен валидны, отображает форму сброса пароля. Если токен невалиден, выполняет перенаправление на URL без токена. Если пользователь не найден, отображает страницу "Password reset unsuccessful". Декорирован `sensitive_post_parameters()` и `never_cache`.
2. `get_user(self, uidb64)`  
    Извлекает пользователя по  
    `uidb64`. Возвращает пользователя или `None`, если пользователь не найден.
3. `get_form_kwargs(self)`  
    Возвращает словарь аргументов для создания формы, включая пользователя (  
    `user`).
4. `form_valid(self, form)`  
    Вызывается при успешной валидации формы. Сохраняет новый пароль, удаляет токен из сессии и при необходимости выполняет аутентификацию пользователя.  
    
5. `get_context_data(self, **kwargs)`
    
    Формирует контекст данных для шаблона. Добавляет переменную `validlink`, указывающую на действительность ссылки сброса пароля. Если ссылка недействительна, устанавливает `form` в `None` и изменяет `title` на "Password reset unsuccessful".
    

### PasswordResetCompleteView

**PasswordResetCompleteView** - это класс, который отображает страницу, информирующую пользователя об успешном изменении пароля.

**Основные характеристики PasswordResetCompleteView:**

1. **Простота использования**  
    Для использования PasswordResetCompleteView достаточно указать его в URL-конфигурации приложения. Представление уже имеет необходимые настройки по умолчанию.  
    

**Контекст шаблона:**

- `title` - заголовок страницы (по умолчанию "Password reset complete")
- `login_url` - URL страницы входа, полученный из настроек (`settings.LOGIN_URL`)

**Наследование**

PasswordResetCompleteView наследуется от двух классов:

1. [[j-m. PasswordChangeView, PasswordChangeDoneView, PasswordContextMixin]] - добавляет переменную `title` в контекст шаблона.
2. [[i-b. Классы TemplateView, ContextMixin, TemplateResponseMixin]] - базовое представление для отображения шаблона страницы.

**Атрибуты класса и их значения по умолчанию:**

1. `template_name = "registration/password_reset_complete.html"`  
    Путь к шаблону страницы, информирующей об успешном изменении пароля.  
    
2. `title = _("Password reset complete")`  
    Заголовок страницы. Значение подготавливается для интернационализации с помощью функции  
    `_()`.

**Метод класса:**

`get_context_data(self, **kwargs)` - Формирует контекст данных для шаблона. Добавляет в контекст переменную `login_url`, содержащую URL страницы входа, полученный из настроек (`settings.LOGIN_URL`).

### Резюме по участию классов в процедуре сброса пароля

- **PasswordResetView**:
    - Пользователь переходит на страницу сброса пароля, где отображается форма для ввода адреса электронной почты.
    - После отправки формы PasswordResetView проверяет, существует ли указанный адрес электронной почты в системе и соответствует ли пользователь определенным условиям (активен, имеет действительный пароль).
    - Если условия выполнены, PasswordResetView генерирует ссылку для сброса пароля и отправляет ее на указанный адрес электронной почты.
    - После успешной отправки письма (или же в случае, если пользователь не был найден в системе и фактически письмо не было отправлено) пользователь перенаправляется на страницу PasswordResetDoneView.
- **PasswordResetDoneView**:
    - Эта страница информирует пользователя о том, что инструкции по сбросу пароля были отправлены на его адрес электронной почты.
    - Пользователь может перейти по ссылке из письма для продолжения процесса сброса пароля.
- **PasswordResetConfirmView**:
    - Когда пользователь переходит по ссылке из письма, он попадает на страницу PasswordResetConfirmView.
    - Эта страница проверяет валидность ссылки сброса пароля на основе переданных параметров (`uidb64` и `token`).
    - Если ссылка действительна, пользователю отображается форма для ввода нового пароля.
    - После отправки формы с новым паролем PasswordResetConfirmView сохраняет новый пароль для пользователя и перенаправляет его на страницу PasswordResetCompleteView.
- **PasswordResetCompleteView**:
    
    - Эта страница информирует пользователя об успешном изменении пароля.
    - Она предоставляет ссылку на страницу входа, чтобы пользователь мог войти в систему с новым паролем.

<div class="page-break" style="page-break-before: always;"></div>
