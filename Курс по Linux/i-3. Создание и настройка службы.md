Определения

Создание и настройка службы

### Определения

**Службы** в Linux - это программы, которые работают в фоновом режиме и предоставляют определенные функциональные возможности или услуги системе или пользователям. Они обычно запускаются при загрузке системы и выполняют свою работу независимо от действий пользователя.  
Службы могут выполнять различные задачи, такие как управление сетью, веб-серверы, базы данных, обслуживание файловой системы и другие. Управление службами в Linux обычно осуществляется с помощью специальных утилит, таких как systemd, systemctl, service и других.  

Термины "службы" и "демоны" в контексте Linux часто используются взаимозаменяемо и обозначают программы, которые работают в фоновом режиме и выполняют определенные задачи независимо от действий пользователя. Оба термина описывают программы, которые обычно запускаются при загрузке системы и могут предоставлять различные функциональные возможности или услуги, такие как управление сетью, веб-серверы, базы данных и т. д.

***.service** - это формат файлов конфигурации, используемых systemd для определения и настройки служб (демонов) в системе. В этих файлах содержится информация о том, как запускать и управлять службой, включая пути к исполняемым файлам, зависимости, параметры запуска и т. д. Файлы .service обычно находятся в каталоге **`/etc/systemd/system/`** или **`/usr/lib/systemd/system/`**.

В systemd используется концепция "**юнитов**" (**units**), которая включает в себя различные типы юнитов, такие как службы (services), сокеты (sockets), монтирования (mounts), устройства (devices) и другие. Каждый юнит представляет собой файл конфигурации, который описывает спецификацию и настройки соответствующего элемента системы, который systemd управляет.

**Target** представляет собой специальный тип юнита, который представляет собой группу других юнитов, к которым применяются определенные действия или состояния. Target определяет набор юнитов, которые должны быть активированы или деактивированы для достижения определенного состояния системы. Например, существуют целевые юниты, такие как multi-user.target, graphical.target и другие, которые определяют различные уровни загрузки системы. Каждый из этих target'ов активирует определенный набор служб и других unit'ов, соответствующих данному состоянию системы.

### Создание и настройка службы

**Создание файла службы:** Создаём файл службы с расширением `**.service**` и сохраняем в директории `**/etc/systemd/system/**`.

В файле службы systemd можно использовать следующие блоки:

1. **[Unit]:**
    - Этот блок содержит общие настройки и зависимости для юнита.
    - **Параметры:**
        - **Requires:** Указывает на другие юниты, от которых зависит данный юнит. Если указанные юниты не запущены, данная служба не будет запущена.
            
            ```Plain
            Requires=network.target syslog.target
            ```
            
        - **After:** Определяет последовательность запуска юнитов. Служба будет запущена только после того, как будут запущены все указанные юниты.
            
            ```Plain
            After=network.target syslog.target
            ```
            
        - **Wants:** Аналогично `**Requires**`, но указывает на желаемые зависимости. Если указанные юниты не запущены, это не приведет к ошибке.
            
            ```Plain
            Wants=network-online.target
            ```
            
        - **Before:** Определяет последовательность запуска юнитов. Служба будет запущена перед запуском всех указанных юнитов.
            
            ```Plain
            Before=shutdown.target
            ```
            
        - **Conflicts:** Определяет список юнитов, с которыми данный юнит конфликтует. Если какие-либо из указанных юнитов уже запущены, данная служба не будет запущена.
            
            ```Plain
            Conflicts=shutdown.target reboot.target
            ```
            
        - **OnFailure:** Определяет действия, которые должны быть выполнены, если юнит завершается с ошибкой.
            
            ```Plain
            OnFailure=notify.service
            ```
            
        - **Description:** Описывает юнит. Это человекочитаемое описание, которое обычно используется для описания функциональности службы.
            
            ```Plain
            Description=My Custom Service
            ```
            
        - **Documentation:** Ссылки на документацию, связанную с этим юнитом.
            
            ```Plain
            Documentation=https://example.com/service-docs
            ```
            
        - и т.д.
2. **[Service]:**
    - Этот блок содержит параметры, связанные с исполняемым процессом службы.
    - **Параметры:**
        - **ExecStart:** Определяет команду или скрипт, который будет запущен при запуске службы.
            
            ```Plain
            ExecStart=/usr/bin/my-service --option=value
            ```
            
        - **ExecStop:** Определяет команду или скрипт, который будет запущен при остановке службы.
            
            ```Plain
            ExecStop=/usr/bin/stop-my-service
            ```
            
        - **WorkingDirectory:** Устанавливает рабочий каталог для выполнения команды службы.
            
            ```Plain
            WorkingDirectory=/var/www/myapp
            ```
            
        - **User:** Задает пользователя, от имени которого будет запущена служба.
            
            ```Plain
            User=myuser
            ```
            
        - **Group:** Задает группу, от имени которой будет запущена служба.
            
            ```Plain
            Group=mygroup
            ```
            
        - **Restart:** Определяет условия перезапуска службы в случае её остановки. Например, always для автоматического перезапуска, on-failure для перезапуска только в случае ошибки и т.д.
            
            ```Plain
            Restart=always
            ```
            
        - **RestartSec:** Задает количество времени, которое systemd ожидает перед тем, как попытаться перезапустить службу после её завершения. Установка небольшой задержки может помочь избежать бесконечного цикла перезапусков в случае, если проблема возникает из-за временного сбоя и может быть автоматически устранена через некоторое время.
            
            ```Plain
            RestartSec=15
            ```
            
        - **Environment:** Определяет переменные окружения для службы.
            
            ```Plain
            Environment=VAR1=value VAR2=value
            ```
            
3. **[Install]:**
    - Этот блок определяет, каким образом юнит должен быть установлен в системе.
    - **Параметры:**
        - **WantedBy:** Определяет целевую цель (target), в которую служба должна быть добавлена. Служба будет запущена при активации этой цели.
            
            ```Plain
            WantedBy=grafical.target
            ```
            
        - **RequiredBy:** Аналогично WantedBy, но устанавливает необходимость службы для указанной цели. Это означает, что при активации цели также будет активирована данная служба.
            
            ```Plain
            RequiredBy=network.target
            ```
            
        - **Alias:** Определяет альтернативные имена для службы, которые могут быть использованы для активации службы.
            
            ```Plain
            Alias=my-service.service
            ```
            
4. **Другие блоки:**  
    В дополнение к блокам [Unit], [Service] и [Install], также могут быть использованы другие блоки, такие как [Socket] (для сетевых сокетов), [Path] (для мониторинга файловых путей) и [Timer] (для запуска задач по расписанию).

<div class="page-break" style="page-break-before: always;"></div>
